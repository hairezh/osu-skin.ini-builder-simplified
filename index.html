<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>A-Editor — skin.ini builder</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e8e8e8; --muted:#7a7a7a;
    --border:rgba(255,255,255,.08); --panel:rgba(255,255,255,.03);
    --fs:14px; --lh:1.6; --r:6px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:var(--fs)/var(--lh) ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    height:100vh;
  }
  .app{height:100vh; display:flex; flex-direction:column;}
  .topbar{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15)), var(--panel);
    gap:10px; flex-wrap:wrap;
  }
  .controls{display:flex; gap:6px; align-items:center; flex-wrap:wrap;}
  .btn{
    cursor:pointer; padding:6px 10px; border-radius:var(--r);
    border:1px solid var(--border); background:rgba(0,0,0,.25);
    color:var(--muted); font-weight:600;
  }
  .btn:hover{color:var(--fg); border-color:rgba(255,255,255,.18);}
  .btn.primary{color:var(--fg); background:rgba(255,255,255,.06);}
  .btn.danger:hover{border-color:rgba(255,120,120,.35); color:rgba(255,210,210,.95);}
  .pill{
    padding:6px 10px; border:1px solid var(--border); border-radius:var(--r);
    background:rgba(0,0,0,.18); color:rgba(232,232,232,.38); font-size:12px;
  }
  .main{flex:1; min-height:0; display:grid; grid-template-columns: 1.1fr 0.9fr; gap:10px; padding:10px;}
  .panel{
    border:1px solid var(--border); border-radius:var(--r);
    background:rgba(255,255,255,.02);
    min-height:0; overflow:hidden;
  }
  .panelHead{
    padding:8px 10px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .tabs{display:flex; gap:6px; flex-wrap:wrap;}
  .tab{
    cursor:pointer; padding:6px 10px; border-radius:var(--r);
    border:1px solid var(--border); background:rgba(0,0,0,.18);
    color:var(--muted); font-weight:600; user-select:none;
  }
  .tab.active{color:var(--fg); border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.05);}
  .panelBody{padding:10px; overflow:auto; max-height:100%;}
  .row{display:grid; grid-template-columns: 190px 1fr; gap:10px; align-items:center; margin-bottom:8px;}
  .row label{color:rgba(232,232,232,.70); font-size:12px;}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;
    border:1px solid var(--border); border-radius:var(--r);
    background:rgba(0,0,0,.22); color:var(--fg);
    padding:7px 9px; outline:none;
    font:inherit;
  }
  textarea{min-height:300px; resize:vertical;}
  input[type="checkbox"]{transform:translateY(1px);}
  input[type="color"]{width:44px; height:34px; border:1px solid var(--border); border-radius:var(--r); background:transparent; padding:0;}
  .hint{color:rgba(232,232,232,.38); font-size:12px; margin:8px 0 0;}
  .sep{height:1px; background:var(--border); margin:12px 0;}
  .mini{font-size:12px; color:rgba(232,232,232,.45);}
  .inline{display:flex; gap:6px; align-items:center; flex-wrap:wrap;}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
  .kbd{border:1px solid var(--border); border-bottom-color:rgba(255,255,255,.14); background:rgba(0,0,0,.22); border-radius:6px; padding:1px 6px;}
  .groupTitle{font-size:12px; color:rgba(232,232,232,.70); margin:2px 0 8px;}
  @media (max-width: 980px){ .main{grid-template-columns: 1fr;} }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="controls">
      <button class="btn primary" id="downloadIni">Download skin.ini</button>
      <button class="btn" id="copyIni">Copy</button>
      <button class="btn danger" id="clearWipe">Clear (wipe)</button>
      <span class="pill" title="Everything stays in your browser (localStorage).">Local autosave • no uploads</span>
    </div>
    <div class="controls">
      <span class="pill" id="statChars">Chars: 0</span>
      <span class="pill" id="statLines">Lines: 0</span>
      <span class="pill" id="savePulse"></span>
    </div>
  </div>

  <div class="main">
    <!-- LEFT -->
    <div class="panel">
      <div class="panelHead">
        <div class="tabs">
          <div class="tab active" data-tab="general">General</div>
          <div class="tab" data-tab="mania">Mania</div>
        </div>
        <div class="mini">General includes Colours + Fonts. Mania auto-builds 4K→7K.</div>
      </div>

      <!-- GENERAL TAB -->
      <div class="panelBody" id="tab-general">
        <div class="groupTitle">[General]</div>
        <div class="row"><label>Name</label><input type="text" id="gName" placeholder="My Skin"></div>
        <div class="row"><label>Author</label><input type="text" id="gAuthor" placeholder="Your name"></div>
        <div class="row">
          <label>Version</label>
          <select id="gVersion">
            <option value="">(leave empty)</option>
            <option>1.0</option><option>2.0</option><option>2.2</option><option>2.5</option>
          </select>
        </div>

        <div class="sep"></div>

        <div class="groupTitle">Cursor toggles</div>
        <div class="row"><label>CursorCentre</label><div class="inline"><input type="checkbox" id="gCursorCentre" checked><span class="mini">0/1</span></div></div>
        <div class="row"><label>CursorExpand</label><div class="inline"><input type="checkbox" id="gCursorExpand"><span class="mini">0/1</span></div></div>
        <div class="row"><label>CursorRotate</label><div class="inline"><input type="checkbox" id="gCursorRotate"><span class="mini">0/1</span></div></div>
        <div class="row"><label>CursorTrailRotate</label><div class="inline"><input type="checkbox" id="gCursorTrailRotate"><span class="mini">0/1</span></div></div>

        <div class="sep"></div>

        <div class="groupTitle">[Colours] (menu/UI)</div>
        <div class="row">
          <label>MenuGlow</label>
          <div class="inline"><input type="color" id="cMenuGlowPick"><input type="text" id="cMenuGlow" placeholder="255,255,255"></div>
        </div>
        <div class="row">
          <label>SongSelectActiveText</label>
          <div class="inline"><input type="color" id="cSongActivePick"><input type="text" id="cSongActive" placeholder="255,255,255"></div>
        </div>
        <div class="row">
          <label>SongSelectInactiveText</label>
          <div class="inline"><input type="color" id="cSongInactivePick"><input type="text" id="cSongInactive" placeholder="160,160,160"></div>
        </div>

        <div class="sep"></div>

        <div class="groupTitle">[Fonts]</div>
        <div class="grid2">
          <div>
            <div class="row"><label>ScorePrefix</label><input type="text" id="fScorePrefix" placeholder="score"></div>
            <div class="row"><label>ScoreOverlap</label><input type="number" id="fScoreOverlap" value="0"></div>
          </div>
          <div>
            <div class="row"><label>ComboPrefix</label><input type="text" id="fComboPrefix" placeholder="combo"></div>
            <div class="row"><label>ComboOverlap</label><input type="number" id="fComboOverlap" value="0"></div>
          </div>
        </div>

        <p class="hint">Export will include a clean [General] + [Colours] + [Fonts].</p>
      </div>

      <!-- MANIA TAB -->
      <div class="panelBody" id="tab-mania" style="display:none">
        <div class="mini">One config → auto-generates 4K, 5K, 6K, 7K blocks.</div>
        <div class="sep"></div>

        <div class="groupTitle">A) Essentials</div>
        <div class="row">
          <label>Keys range</label>
          <div class="inline">
            <span class="mini">Auto:</span>
            <span class="kbd">4K</span><span class="mini">→</span><span class="kbd">7K</span>
            <span class="mini">(fixed)</span>
          </div>
        </div>

        <div class="row">
          <label>ColumnWidth (per col)</label>
          <input type="number" id="mColWidth" value="70">
        </div>

        <div class="row">
          <label>ColumnSpacing (between)</label>
          <input type="number" id="mColSpacing" value="0">
        </div>

        <div class="row">
          <label>Auto-center ColumnStart</label>
          <div class="inline">
            <input type="checkbox" id="mAutoCenter" checked>
            <span class="mini">Adds ColumnStart automatically</span>
          </div>
        </div>

        <div class="row">
          <label>Aspect ratio</label>
          <div class="inline">
            <select id="mARPreset">
              <option value="16:9" selected>16:9</option>
              <option value="4:3">4:3</option>
              <option value="21:9">21:9</option>
              <option value="custom">Custom</option>
            </select>
            <input type="number" id="mARW" value="16" style="max-width:110px" title="Custom width">
            <input type="number" id="mARH" value="9" style="max-width:110px" title="Custom height">
            <span class="mini">AR = W/H</span>
          </div>
        </div>

        <div class="row">
          <label>Fine adjust (px)</label>
          <input type="number" id="mCenterOffset" value="0">
        </div>

        <div class="row"><label>HitPosition</label><input type="number" id="mHitPos" value="402"></div>
        <div class="row"><label>ScorePosition</label><input type="number" id="mScorePos" value="260"></div>
        <div class="row"><label>ComboPosition</label><input type="number" id="mComboPos" value="240"></div>

        <div class="row">
          <label>JudgementLine</label>
          <div class="inline">
            <input type="checkbox" id="mJudgementLine" checked>
            <span class="mini">0/1</span>
          </div>
        </div>

        <div class="row">
          <label>UpsideDown</label>
          <div class="inline">
            <input type="checkbox" id="mUpsideDown">
            <span class="mini">0/1</span>
          </div>
        </div>

        <div class="row">
          <label>KeysUnderNotes</label>
          <div class="inline">
            <input type="checkbox" id="mKeysUnderNotes">
            <span class="mini">0/1</span>
          </div>
        </div>

        <div class="sep"></div>
        <div class="groupTitle">B) Reading refinements</div>
        <div class="row"><label>ColumnLineWidth (per col)</label><input type="number" id="mLineWidth" value="0"></div>
        <div class="row"><label>BarlineHeight</label><input type="number" id="mBarlineHeight" value=""></div>
        <div class="row"><label>WidthForNoteHeightScale</label><input type="number" id="mNoteHeightScale" value=""></div>
        <div class="row"><label>LightPosition</label><input type="number" id="mLightPos" value=""></div>

        <div class="sep"></div>
        <div class="groupTitle">C) Stage / Lighting</div>
        <div class="grid2">
          <div>
            <div class="row"><label>StageLeft</label><input type="text" id="mStageLeft" placeholder=""></div>
            <div class="row"><label>StageRight</label><input type="text" id="mStageRight" placeholder=""></div>
            <div class="row"><label>StageBottom</label><input type="text" id="mStageBottom" placeholder=""></div>
            <div class="row"><label>StageHint</label><input type="text" id="mStageHint" placeholder=""></div>
            <div class="row"><label>StageLight</label><input type="text" id="mStageLight" placeholder=""></div>
          </div>
          <div>
            <div class="row"><label>LightingNWidth</label><input type="number" id="mLightNWidth" value=""></div>
            <div class="row"><label>LightingLWidth</label><input type="number" id="mLightLWidth" value=""></div>
            <div class="row"><label>LightingN</label><input type="text" id="mLightingN" placeholder=""></div>
            <div class="row"><label>LightingL</label><input type="text" id="mLightingL" placeholder=""></div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="groupTitle">D) Colours</div>
        <div class="row">
          <label>ColourHold</label>
          <div class="inline"><input type="color" id="mHoldPick"><input type="text" id="mColourHold" placeholder="255,255,255"></div>
        </div>
        <div class="row">
          <label>ColourBreak</label>
          <div class="inline"><input type="color" id="mBreakPick"><input type="text" id="mColourBreak" placeholder="255,80,80"></div>
        </div>

        <div class="mini">Colour# (for keys) — set up to 7. 4K/5K/6K use the first N.</div>
        <div class="grid2" style="margin-top:8px">
          <div class="inline">
            <span class="mini">1</span><input type="color" id="kCol1"><input type="text" id="kRgb1" placeholder="255,255,255">
          </div>
          <div class="inline">
            <span class="mini">2</span><input type="color" id="kCol2"><input type="text" id="kRgb2" placeholder="255,255,255">
          </div>
          <div class="inline">
            <span class="mini">3</span><input type="color" id="kCol3"><input type="text" id="kRgb3" placeholder="255,255,255">
          </div>
          <div class="inline">
            <span class="mini">4</span><input type="color" id="kCol4"><input type="text" id="kRgb4" placeholder="255,255,255">
          </div>
          <div class="inline">
            <span class="mini">5</span><input type="color" id="kCol5"><input type="text" id="kRgb5" placeholder="255,255,255">
          </div>
          <div class="inline">
            <span class="mini">6</span><input type="color" id="kCol6"><input type="text" id="kRgb6" placeholder="255,255,255">
          </div>
          <div class="inline">
            <span class="mini">7</span><input type="color" id="kCol7"><input type="text" id="kRgb7" placeholder="255,255,255">
          </div>
        </div>

        <div class="sep"></div>
        <div class="groupTitle">E) Images (simplified patterns)</div>
        <div class="mini">Use <span class="kbd">{n}</span> for key number (1..Keys). Example: <span class="kbd">key{n}</span>.</div>

        <div class="grid2" style="margin-top:8px">
          <div>
            <div class="row"><label>KeyImage# pattern</label><input type="text" id="pKey" placeholder="key{n}"></div>
            <div class="row"><label>KeyImage#D pattern</label><input type="text" id="pKeyD" placeholder="key{n}D"></div>
          </div>
          <div>
            <div class="row"><label>NoteImage# pattern</label><input type="text" id="pNote" placeholder="note{n}"></div>
            <div class="row"><label>NoteImage#H pattern</label><input type="text" id="pNoteH" placeholder="note{n}H"></div>
          </div>
        </div>

        <div class="grid2">
          <div>
            <div class="row"><label>NoteImage#L pattern</label><input type="text" id="pNoteL" placeholder="note{n}L"></div>
            <div class="row"><label>NoteImage#T pattern</label><input type="text" id="pNoteT" placeholder="note{n}T"></div>
          </div>
          <div class="row" style="grid-template-columns:190px 1fr;">
            <label>WarningArrow</label><input type="text" id="mWarningArrow" placeholder="">
          </div>
        </div>

        <div class="sep"></div>
        <div class="groupTitle">F) Hit sprites</div>
        <div class="grid2">
          <div class="row"><label>Hit0</label><input type="text" id="h0" placeholder=""></div>
          <div class="row"><label>Hit50</label><input type="text" id="h50" placeholder=""></div>
          <div class="row"><label>Hit100</label><input type="text" id="h100" placeholder=""></div>
          <div class="row"><label>Hit200</label><input type="text" id="h200" placeholder=""></div>
          <div class="row"><label>Hit300</label><input type="text" id="h300" placeholder=""></div>
          <div class="row"><label>Hit300g</label><input type="text" id="h300g" placeholder=""></div>
        </div>

        <p class="hint">Export writes 4 blocks: Keys 4/5/6/7, ordered by importance and kept compact.</p>
      </div>
    </div>

    <!-- RIGHT PREVIEW -->
    <div class="panel">
      <div class="panelHead">
        <div class="mini">Generated skin.ini</div>
        <div class="mini">Mania: auto 4K→7K</div>
      </div>
      <div class="panelBody">
        <textarea id="preview" readonly></textarea>
        <p class="hint">This is exactly what will be downloaded as <span class="kbd">skin.ini</span>.</p>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= helpers ========= */
const $ = (id)=>document.getElementById(id);
const STORAGE_KEY = "aeditor_skinini_builder_v2";

const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const bool01 = (b)=> (b ? "1" : "0");

function cleanLine(s){ return String(s??"").replace(/\r/g,"").trimEnd(); }

function rgbToHex(rgb){
  const m = String(rgb||"").match(/^\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*$/);
  if(!m) return null;
  const r = clamp(parseInt(m[1],10),0,255);
  const g = clamp(parseInt(m[2],10),0,255);
  const b = clamp(parseInt(m[3],10),0,255);
  return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
}
function hexToRgb(hex){
  const h = String(hex||"").replace("#","").trim();
  if(!/^[0-9a-fA-F]{6}$/.test(h)) return "";
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `${r},${g},${b}`;
}
function bindColourSync(pickId, textId){
  const pick = $(pickId);
  const txt = $(textId);
  const hx = rgbToHex(txt.value);
  if(hx) pick.value = hx;

  pick.addEventListener("input", ()=>{
    txt.value = hexToRgb(pick.value);
    scheduleUpdate();
  });
  txt.addEventListener("input", ()=>{
    const hx2 = rgbToHex(txt.value);
    if(hx2) pick.value = hx2;
    scheduleUpdate();
  });
}

/* CSV generators */
function csvRepeat(value, count){
  return Array.from({length: count}, ()=>String(value)).join(",");
}
function csvBetween(value, keys){
  return csvRepeat(value, Math.max(0, keys-1));
}

/* Desmos-style auto-center:
   usableWidth = 480 * aspectRatio
   columnSum = (colWidth*keys) + (colSpacing*(keys-1))
   columnStart = round(usableWidth/2 - columnSum/2) + offset
*/
function getAspectRatio(){
  const preset = $("mARPreset").value;
  let w = Number($("mARW").value || 16);
  let h = Number($("mARH").value || 9);

  if(preset !== "custom"){
    const [pw,ph] = preset.split(":").map(Number);
    if(Number.isFinite(pw) && Number.isFinite(ph) && ph !== 0){
      w = pw; h = ph;
      $("mARW").value = String(pw);
      $("mARH").value = String(ph);
    }
  }
  if(!Number.isFinite(w) || !Number.isFinite(h) || h === 0) return 16/9;
  return w / h;
}

function calcColumnStart(keys, colWidth, colSpacing, aspectRatio, offset){
  const usableWidth = 480 * aspectRatio;
  const columnSum = (colWidth * keys) + (colSpacing * (keys - 1));
  return Math.round((usableWidth/2) - (columnSum/2)) + Number(offset || 0);
}

/* Pattern expander for KeyImage#/NoteImage# */
function pat(pattern, n){
  const p = String(pattern||"").trim();
  if(!p) return "";
  return p.replaceAll("{n}", String(n));
}

/* ========= tabs ========= */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  $("tab-general").style.display = (name==="general") ? "block" : "none";
  $("tab-mania").style.display   = (name==="mania") ? "block" : "none";
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});

/* ========= ini generation ========= */
function pushIf(arr, key, value){
  const v = cleanLine(value);
  if(v !== "") arr.push(`${key}: ${v}`);
}

function maniaBlockForKeys(keys){
  const lines = [];

  // Read common inputs
  const colW = Number($("mColWidth").value || 0);
  const colS = Number($("mColSpacing").value || 0);
  const lineW = Number($("mLineWidth").value || 0);
  const ar = getAspectRatio();
  const autoCenter = $("mAutoCenter").checked;
  const offset = Number($("mCenterOffset").value || 0);

  // --- A) Essentials (ordered)
  lines.push(`Keys: ${keys}`);
  lines.push(`ColumnWidth: ${csvRepeat(colW, keys)}`);
  lines.push(`ColumnSpacing: ${csvBetween(colS, keys)}`);

  if(autoCenter){
    const cs = calcColumnStart(keys, colW, colS, ar, offset);
    lines.push(`ColumnStart: ${cs}`);
  } else {
    // if user disables auto-center, you can still set manual start by writing offset as ColumnStart if desired
    // (keeping simple: omit)
  }

  pushIf(lines, "HitPosition", $("mHitPos").value);
  pushIf(lines, "ScorePosition", $("mScorePos").value);
  pushIf(lines, "ComboPosition", $("mComboPos").value);

  lines.push(`JudgementLine: ${bool01($("mJudgementLine").checked)}`);
  lines.push(`UpsideDown: ${bool01($("mUpsideDown").checked)}`);
  lines.push(`KeysUnderNotes: ${bool01($("mKeysUnderNotes").checked)}`);

  // --- B) Reading refinements (ordered)
  lines.push(`ColumnLineWidth: ${csvRepeat(lineW, keys)}`);
  pushIf(lines, "BarlineHeight", $("mBarlineHeight").value);
  pushIf(lines, "WidthForNoteHeightScale", $("mNoteHeightScale").value);
  pushIf(lines, "LightPosition", $("mLightPos").value);

  // --- C) Stage / Lighting (ordered by shorter names inside group)
  pushIf(lines, "StageLeft", $("mStageLeft").value);
  pushIf(lines, "StageRight", $("mStageRight").value);
  pushIf(lines, "StageBottom", $("mStageBottom").value);
  pushIf(lines, "StageHint", $("mStageHint").value);
  pushIf(lines, "StageLight", $("mStageLight").value);

  pushIf(lines, "LightingNWidth", $("mLightNWidth").value);
  pushIf(lines, "LightingLWidth", $("mLightLWidth").value);
  pushIf(lines, "LightingN", $("mLightingN").value);
  pushIf(lines, "LightingL", $("mLightingL").value);

  // --- D) Colours (ordered: hold/break first, then Colour#)
  pushIf(lines, "ColourHold", $("mColourHold").value);
  pushIf(lines, "ColourBreak", $("mColourBreak").value);

  // Colour# (1..keys), taking first N from 1..7
  for(let i=1;i<=keys;i++){
    const v = cleanLine($("kRgb"+i).value);
    if(v) lines.push(`Colour${i}: ${v}`);
  }

  // --- E) Images (patterns)
  // KeyImage#
  const pKey = $("pKey").value;
  const pKeyD = $("pKeyD").value;
  const pNote = $("pNote").value;
  const pNoteH = $("pNoteH").value;
  const pNoteL = $("pNoteL").value;
  const pNoteT = $("pNoteT").value;

  for(let i=1;i<=keys;i++){
    const a = pat(pKey, i);
    if(a) lines.push(`KeyImage${i}: ${a}`);
  }
  for(let i=1;i<=keys;i++){
    const a = pat(pKeyD, i);
    if(a) lines.push(`KeyImage${i}D: ${a}`);
  }
  for(let i=1;i<=keys;i++){
    const a = pat(pNote, i);
    if(a) lines.push(`NoteImage${i}: ${a}`);
  }
  for(let i=1;i<=keys;i++){
    const a = pat(pNoteH, i);
    if(a) lines.push(`NoteImage${i}H: ${a}`);
  }
  for(let i=1;i<=keys;i++){
    const a = pat(pNoteL, i);
    if(a) lines.push(`NoteImage${i}L: ${a}`);
  }
  for(let i=1;i<=keys;i++){
    const a = pat(pNoteT, i);
    if(a) lines.push(`NoteImage${i}T: ${a}`);
  }

  pushIf(lines, "WarningArrow", $("mWarningArrow").value);

  // --- F) Hit sprites (ordered)
  pushIf(lines, "Hit0", $("h0").value);
  pushIf(lines, "Hit50", $("h50").value);
  pushIf(lines, "Hit100", $("h100").value);
  pushIf(lines, "Hit200", $("h200").value);
  pushIf(lines, "Hit300", $("h300").value);
  pushIf(lines, "Hit300g", $("h300g").value);

  // remove empties (safety)
  return lines.filter(x => x.trim() !== "");
}

function genIni(){
  const out = [];

  // [General]
  const G = [];
  pushIf(G, "Name", $("gName").value);
  pushIf(G, "Author", $("gAuthor").value);
  pushIf(G, "Version", $("gVersion").value);
  G.push(`CursorCentre: ${bool01($("gCursorCentre").checked)}`);
  G.push(`CursorExpand: ${bool01($("gCursorExpand").checked)}`);
  G.push(`CursorRotate: ${bool01($("gCursorRotate").checked)}`);
  G.push(`CursorTrailRotate: ${bool01($("gCursorTrailRotate").checked)}`);

  if(G.length){
    out.push("[General]");
    out.push(...G);
    out.push("");
  }

  // [Colours] (menu/UI)
  const C = [];
  pushIf(C, "MenuGlow", $("cMenuGlow").value);
  pushIf(C, "SongSelectActiveText", $("cSongActive").value);
  pushIf(C, "SongSelectInactiveText", $("cSongInactive").value);

  if(C.length){
    out.push("[Colours]");
    out.push(...C);
    out.push("");
  }

  // [Fonts]
  const F = [];
  pushIf(F, "ScorePrefix", $("fScorePrefix").value);
  pushIf(F, "ScoreOverlap", $("fScoreOverlap").value);
  pushIf(F, "ComboPrefix", $("fComboPrefix").value);
  pushIf(F, "ComboOverlap", $("fComboOverlap").value);

  if(F.length){
    out.push("[Fonts]");
    out.push(...F);
    out.push("");
  }

  // [Mania] blocks: 4K..7K (best choice for usability/compat)
  for(const keys of [4,5,6,7]){
    out.push("[Mania]");
    out.push(...maniaBlockForKeys(keys));
    out.push("");
  }

  while(out.length && out[out.length-1] === "") out.pop();
  return out.join("\n");
}

/* ========= autosave ========= */
let saveTimer = null;
function saveState(){
  const s = {
    gName: $("gName").value, gAuthor: $("gAuthor").value, gVersion: $("gVersion").value,
    gCursorCentre: $("gCursorCentre").checked, gCursorExpand: $("gCursorExpand").checked,
    gCursorRotate: $("gCursorRotate").checked, gCursorTrailRotate: $("gCursorTrailRotate").checked,

    cMenuGlow: $("cMenuGlow").value, cSongActive: $("cSongActive").value, cSongInactive: $("cSongInactive").value,

    fScorePrefix: $("fScorePrefix").value, fScoreOverlap: $("fScoreOverlap").value,
    fComboPrefix: $("fComboPrefix").value, fComboOverlap: $("fComboOverlap").value,

    mColWidth: $("mColWidth").value, mColSpacing: $("mColSpacing").value,
    mAutoCenter: $("mAutoCenter").checked, mARPreset: $("mARPreset").value,
    mARW: $("mARW").value, mARH: $("mARH").value, mCenterOffset: $("mCenterOffset").value,

    mHitPos: $("mHitPos").value, mScorePos: $("mScorePos").value, mComboPos: $("mComboPos").value,
    mJudgementLine: $("mJudgementLine").checked, mUpsideDown: $("mUpsideDown").checked, mKeysUnderNotes: $("mKeysUnderNotes").checked,

    mLineWidth: $("mLineWidth").value, mBarlineHeight: $("mBarlineHeight").value,
    mNoteHeightScale: $("mNoteHeightScale").value, mLightPos: $("mLightPos").value,

    mStageLeft: $("mStageLeft").value, mStageRight: $("mStageRight").value,
    mStageBottom: $("mStageBottom").value, mStageHint: $("mStageHint").value, mStageLight: $("mStageLight").value,
    mLightNWidth: $("mLightNWidth").value, mLightLWidth: $("mLightLWidth").value,
    mLightingN: $("mLightingN").value, mLightingL: $("mLightingL").value,

    mColourHold: $("mColourHold").value, mColourBreak: $("mColourBreak").value,
    kRgb: [1,2,3,4,5,6,7].map(i => $("kRgb"+i).value),

    pKey: $("pKey").value, pKeyD: $("pKeyD").value,
    pNote: $("pNote").value, pNoteH: $("pNoteH").value, pNoteL: $("pNoteL").value, pNoteT: $("pNoteT").value,
    mWarningArrow: $("mWarningArrow").value,

    h0: $("h0").value, h50: $("h50").value, h100: $("h100").value,
    h200: $("h200").value, h300: $("h300").value, h300g: $("h300g").value,
  };

  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    $("savePulse").textContent = "Saved";
    setTimeout(()=>{ $("savePulse").textContent=""; }, 700);
  }catch(e){}
}

function loadState(){
  let raw=null;
  try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
  if(!raw) return;

  try{
    const s = JSON.parse(raw);
    if(!s) return;

    $("gName").value = s.gName ?? "";
    $("gAuthor").value = s.gAuthor ?? "";
    $("gVersion").value = s.gVersion ?? "";
    $("gCursorCentre").checked = !!s.gCursorCentre;
    $("gCursorExpand").checked = !!s.gCursorExpand;
    $("gCursorRotate").checked = !!s.gCursorRotate;
    $("gCursorTrailRotate").checked = !!s.gCursorTrailRotate;

    $("cMenuGlow").value = s.cMenuGlow ?? "";
    $("cSongActive").value = s.cSongActive ?? "";
    $("cSongInactive").value = s.cSongInactive ?? "";

    $("fScorePrefix").value = s.fScorePrefix ?? "";
    $("fScoreOverlap").value = s.fScoreOverlap ?? "0";
    $("fComboPrefix").value = s.fComboPrefix ?? "";
    $("fComboOverlap").value = s.fComboOverlap ?? "0";

    $("mColWidth").value = s.mColWidth ?? "70";
    $("mColSpacing").value = s.mColSpacing ?? "0";
    $("mAutoCenter").checked = (s.mAutoCenter ?? true);
    $("mARPreset").value = s.mARPreset ?? "16:9";
    $("mARW").value = s.mARW ?? "16";
    $("mARH").value = s.mARH ?? "9";
    $("mCenterOffset").value = s.mCenterOffset ?? "0";

    $("mHitPos").value = s.mHitPos ?? "402";
    $("mScorePos").value = s.mScorePos ?? "260";
    $("mComboPos").value = s.mComboPos ?? "240";
    $("mJudgementLine").checked = (s.mJudgementLine ?? true);
    $("mUpsideDown").checked = !!s.mUpsideDown;
    $("mKeysUnderNotes").checked = !!s.mKeysUnderNotes;

    $("mLineWidth").value = s.mLineWidth ?? "0";
    $("mBarlineHeight").value = s.mBarlineHeight ?? "";
    $("mNoteHeightScale").value = s.mNoteHeightScale ?? "";
    $("mLightPos").value = s.mLightPos ?? "";

    $("mStageLeft").value = s.mStageLeft ?? "";
    $("mStageRight").value = s.mStageRight ?? "";
    $("mStageBottom").value = s.mStageBottom ?? "";
    $("mStageHint").value = s.mStageHint ?? "";
    $("mStageLight").value = s.mStageLight ?? "";

    $("mLightNWidth").value = s.mLightNWidth ?? "";
    $("mLightLWidth").value = s.mLightLWidth ?? "";
    $("mLightingN").value = s.mLightingN ?? "";
    $("mLightingL").value = s.mLightingL ?? "";

    $("mColourHold").value = s.mColourHold ?? "";
    $("mColourBreak").value = s.mColourBreak ?? "";
    const arr = Array.isArray(s.kRgb) ? s.kRgb : (Array.isArray(s.kRgb) ? s.kRgb : []);
    if(Array.isArray(s.kRgb)){
      for(let i=1;i<=7;i++) $("kRgb"+i).value = s.kRgb[i-1] ?? "";
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else if(Array.isArray(s.kRgb)){
      // noop
    } else {
      // fallback: array saved in s.kRgb
      if(Array.isArray(arr)){
        for(let i=1;i<=7;i++) $("kRgb"+i).value = arr[i-1] ?? "";
      }
    }

    $("pKey").value = s.pKey ?? "";
    $("pKeyD").value = s.pKeyD ?? "";
    $("pNote").value = s.pNote ?? "";
    $("pNoteH").value = s.pNoteH ?? "";
    $("pNoteL").value = s.pNoteL ?? "";
    $("pNoteT").value = s.pNoteT ?? "";
    $("mWarningArrow").value = s.mWarningArrow ?? "";

    $("h0").value = s.h0 ?? "";
    $("h50").value = s.h50 ?? "";
    $("h100").value = s.h100 ?? "";
    $("h200").value = s.h200 ?? "";
    $("h300").value = s.h300 ?? "";
    $("h300g").value = s.h300g ?? "";
  }catch(e){}
}

/* ========= live update ========= */
function updatePreview(){
  const ini = genIni();
  $("preview").value = ini;
  $("statChars").textContent = `Chars: ${ini.length}`;
  $("statLines").textContent = `Lines: ${ini ? ini.split("\n").length : 0}`;
}
function scheduleUpdate(){
  updatePreview();
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveState, 250);
}

/* ========= actions ========= */
function downloadIni(){
  const text = $("preview").value;
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "skin.ini";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
async function copyIni(){
  const text = $("preview").value;
  try{
    await navigator.clipboard.writeText(text);
    $("savePulse").textContent = "Copied";
    setTimeout(()=>{ $("savePulse").textContent=""; }, 700);
  }catch(e){
    $("preview").focus(); $("preview").select();
    document.execCommand("copy");
  }
}
function clearWipe(){
  if(!confirm("Clear everything (and remove local autosave)?")) return;
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  location.reload();
}

$("downloadIni").addEventListener("click", downloadIni);
$("copyIni").addEventListener("click", copyIni);
$("clearWipe").addEventListener("click", clearWipe);

/* Bind inputs */
[
  "gName","gAuthor","gVersion",
  "gCursorCentre","gCursorExpand","gCursorRotate","gCursorTrailRotate",
  "cMenuGlow","cSongActive","cSongInactive",
  "fScorePrefix","fScoreOverlap","fComboPrefix","fComboOverlap",
  "mColWidth","mColSpacing","mAutoCenter","mARPreset","mARW","mARH","mCenterOffset",
  "mHitPos","mScorePos","mComboPos","mJudgementLine","mUpsideDown","mKeysUnderNotes",
  "mLineWidth","mBarlineHeight","mNoteHeightScale","mLightPos",
  "mStageLeft","mStageRight","mStageBottom","mStageHint","mStageLight",
  "mLightNWidth","mLightLWidth","mLightingN","mLightingL",
  "mColourHold","mColourBreak",
  "pKey","pKeyD","pNote","pNoteH","pNoteL","pNoteT","mWarningArrow",
  "h0","h50","h100","h200","h300","h300g",
  "kRgb1","kRgb2","kRgb3","kRgb4","kRgb5","kRgb6","kRgb7"
].forEach(id=>{
  $(id).addEventListener("input", scheduleUpdate);
  $(id).addEventListener("change", scheduleUpdate);
});

/* Colour sync bindings */
bindColourSync("cMenuGlowPick","cMenuGlow");
bindColourSync("cSongActivePick","cSongActive");
bindColourSync("cSongInactivePick","cSongInactive");
bindColourSync("mHoldPick","mColourHold");
bindColourSync("mBreakPick","mColourBreak");
for(let i=1;i<=7;i++){
  // per-key colour
  const pickId = "kCol"+i;
  const txtId = "kRgb"+i;
  // init pick
  const hx = rgbToHex($(txtId).value);
  if(hx) $(pickId).value = hx;
  $(pickId).addEventListener("input", ()=>{
    $(txtId).value = hexToRgb($(pickId).value);
    scheduleUpdate();
  });
  $(txtId).addEventListener("input", ()=>{
    const hx2 = rgbToHex($(txtId).value);
    if(hx2) $(pickId).value = hx2;
    scheduleUpdate();
  });
}

/* Init defaults (nice) */
function seedDefaultsIfEmpty(){
  if(!$("cMenuGlow").value) $("cMenuGlow").value = "255,255,255";
  if(!$("cSongActive").value) $("cSongActive").value = "255,255,255";
  if(!$("cSongInactive").value) $("cSongInactive").value = "160,160,160";

  // Key colours default (soft tournament-ish)
  const defs = ["255,255,255","255,220,120","180,240,255","255,170,220","200,255,200","255,200,160","220,200,255"];
  for(let i=1;i<=7;i++){
    if(!$("kRgb"+i).value) $("kRgb"+i).value = defs[i-1];
    const hx = rgbToHex($("kRgb"+i).value);
    if(hx) $("kCol"+i).value = hx;
  }
}

loadState();
seedDefaultsIfEmpty();
updatePreview();
</script>
</body>
</html>
