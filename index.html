<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="https://i.pinimg.com/1200x/d6/ca/e4/d6cae471e8471dec46c4304104adb4b1.jpg"/>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>skin.ini</title>

  <style>
    :root{
      --bg:#0b0c0f; --fg:#e8e8e8; --muted:#7a7a7a;
      --border:rgba(255,255,255,.08); --panel:rgba(255,255,255,.03);
      --fs:14px; --lh:1.6; --r:6px;

      /* select */
      --selBg:#000;
      --selBorder:rgba(255,255,255,.12);
      --selHi:#111;
    }

    *{ box-sizing:border-box; }

    /* Scrollbars (Firefox) */
    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(200,200,200,.35) rgba(0,0,0,.15);
    }
    /* Scrollbars (Chromium/WebKit) */
    *::-webkit-scrollbar{ width:10px; height:10px; }
    *::-webkit-scrollbar-track{
      background: rgba(0,0,0,.15);
      border-radius: 6px;
    }
    *::-webkit-scrollbar-thumb{
      background: rgba(200,200,200,.30);
      border: 2px solid rgba(0,0,0,.15);
      border-radius: 6px;
    }
    *::-webkit-scrollbar-thumb:hover{
      background: rgba(200,200,200,.42);
    }

    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:var(--fs)/var(--lh) ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      height:100vh;
    }
    .app{ height:100vh; display:flex; flex-direction:column; }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15)), var(--panel);
      gap:10px; flex-wrap:wrap;
    }
    .controls{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .btn{
      cursor:pointer; padding:6px 10px; border-radius:var(--r);
      border:1px solid var(--border); background:rgba(0,0,0,.25);
      color:var(--muted); font-weight:600;
    }
    .btn:hover{ color:var(--fg); border-color:rgba(255,255,255,.18); }
    .btn.primary{ color:var(--fg); background:rgba(255,255,255,.06); }
    .btn.danger:hover{ border-color:rgba(255,120,120,.35); color:rgba(255,210,210,.95); }
    .pill{
      padding:6px 10px; border:1px solid var(--border); border-radius:var(--r);
      background:rgba(0,0,0,.18); color:rgba(232,232,232,.38); font-size:12px;
    }

    .main{
      flex:1; min-height:0;
      display:grid; grid-template-columns: 1.1fr 0.9fr;
      gap:10px; padding:10px;
    }
    .panel{
      border:1px solid var(--border); border-radius:var(--r);
      background:rgba(255,255,255,.02);
      min-height:0; overflow:hidden;
      display:flex; flex-direction:column;
    }
    .panelHead{
      padding:8px 10px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .tabs{ display:flex; gap:6px; flex-wrap:wrap; }
    .tab{
      cursor:pointer; padding:6px 10px; border-radius:var(--r);
      border:1px solid var(--border); background:rgba(0,0,0,.18);
      color:var(--muted); font-weight:600; user-select:none;
    }
    .tab.active{ color:var(--fg); border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.05); }

    .panelBody{
      padding:10px; overflow:auto;
      flex:1; min-height:0;
    }

    .row{ display:grid; grid-template-columns: 190px 1fr; gap:10px; align-items:center; margin-bottom:8px; }
    .row label{ color:rgba(232,232,232,.70); font-size:12px; }

    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      border:1px solid var(--border); border-radius:var(--r);
      background:rgba(0,0,0,.22); color:var(--fg);
      padding:7px 9px; outline:none;
      font:inherit;
    }

    textarea{
      min-height: calc(100vh - 170px);
      resize:none;
    }

    input[type="color"]{
      width:44px; height:34px;
      border:1px solid var(--border); border-radius:var(--r);
      background:transparent; padding:0;
    }

    .hint{ color:rgba(232,232,232,.38); font-size:12px; margin:8px 0 0; }
    .sep{ height:1px; background:var(--border); margin:12px 0; }
    .mini{ font-size:12px; color:rgba(232,232,232,.45); }
    .inline{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kbd{ border:1px solid var(--border); border-bottom-color:rgba(255,255,255,.14); background:rgba(0,0,0,.22); border-radius:6px; padding:1px 6px; }
    .groupTitle{ font-size:12px; color:rgba(232,232,232,.70); margin:2px 0 8px; }

    /* Minimal switch */
    .switch{ display:inline-flex; align-items:center; gap:8px; }
    .switch input{ display:none; }
    .sw{
      width:44px; height:24px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      border-radius:6px;
      position:relative;
      transition:140ms linear;
    }
    .sw::after{
      content:"";
      width:18px; height:18px;
      position:absolute; top:50%; left:3px;
      transform:translateY(-50%);
      border-radius:5px;
      background:rgba(255,255,255,.25);
      transition:140ms linear;
    }
    .switch input:checked + .sw{
      border-color:rgba(255,255,255,.18);
      background:rgba(255,255,255,.05);
    }
    .switch input:checked + .sw::after{
      left:23px;
      background:rgba(255,255,255,.55);
    }

    .switchLabel{
      font-size:12px;
      color:rgba(232,232,232,.55);
      font-weight:600;
      user-select:none;
    }

    /* per-mode blocks */
    .modeBlock{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.015);
      border-radius:8px;
      padding:10px;
      margin:10px 0 14px;
    }
    .modeHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .modeTag{
      font-weight:700;
      color:rgba(232,232,232,.85);
    }

    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
      textarea{ min-height: 55vh; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="controls">
        <button class="btn primary" id="downloadIni">Download skin.ini</button>
        <button class="btn danger" id="clearWipe">Clear (wipe)</button>
        <span class="pill" id="savePulse"></span>
      </div>
      <div class="controls">
        <span class="pill">Version 1.6 [Beta]</span>

        <span class="pill" style="display:flex; align-items:center; gap:10px;">
          <span class="switchLabel">hairez-style</span>
          <label class="switch" title="Pretty formatting (aligned + spaced groups)">
            <input type="checkbox" id="prettyFormat" checked>
            <span class="sw"></span>
          </label>
        </span>
      </div>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="panel">
        <div class="panelHead">
          <div class="tabs">
            <div class="tab active" data-tab="general">General</div>
            <div class="tab" data-tab="mania">Mania</div>
          </div>
          <div class="mini">Mania uses toggles (4K/6K/7K only). Patterns are per keymode.</div>
        </div>

        <!-- GENERAL -->
        <div class="panelBody" id="tab-general">
          <div class="groupTitle">[General]</div>
          <div class="row"><label>Name</label><input type="text" id="gName" placeholder="Example: my skin"></div>
          <div class="row"><label>Author</label><input type="text" id="gAuthor" placeholder="Your name"></div>
          <div class="row"><label>Version</label><input type="text" id="gVersion" value="latest" readonly></div>

          <div class="sep"></div>
          <div class="groupTitle">Cursor</div>

          <div class="row">
            <label>CursorCentre</label>
            <div class="inline"><label class="switch"><input type="checkbox" id="gCursorCentre" checked><span class="sw"></span></label></div>
          </div>
          <div class="row">
            <label>CursorExpand</label>
            <div class="inline"><label class="switch"><input type="checkbox" id="gCursorExpand"><span class="sw"></span></label></div>
          </div>
          <div class="row">
            <label>CursorRotate</label>
            <div class="inline"><label class="switch"><input type="checkbox" id="gCursorRotate"><span class="sw"></span></label></div>
          </div>
          <div class="row">
            <label>CursorTrailRotate</label>
            <div class="inline"><label class="switch"><input type="checkbox" id="gCursorTrailRotate"><span class="sw"></span></label></div>
          </div>

          <div class="sep"></div>
          <div class="groupTitle">[Colours] (menu/UI)</div>

          <div class="row">
            <label>MenuGlow</label>
            <div class="inline"><input type="color" id="cMenuGlowPick"><input type="text" id="cMenuGlow" placeholder="0,0,0"></div>
          </div>
          <div class="row">
            <label>SongSelectActiveText</label>
            <div class="inline"><input type="color" id="cSongActivePick"><input type="text" id="cSongActive" placeholder="200,200,200"></div>
          </div>
          <div class="row">
            <label>SongSelectInactiveText</label>
            <div class="inline"><input type="color" id="cSongInactivePick"><input type="text" id="cSongInactive" placeholder="100,100,100"></div>
          </div>

          <div class="sep"></div>
          <div class="groupTitle">[Fonts]</div>

          <div class="grid2">
            <div>
              <div class="row"><label>ScorePrefix</label><input type="text" id="fScorePrefix" placeholder="score"></div>
              <div class="row"><label>ScoreOverlap</label><input type="number" id="fScoreOverlap" value="0"></div>
            </div>
            <div>
              <div class="row"><label>ComboPrefix</label><input type="text" id="fComboPrefix" placeholder="combo"></div>
              <div class="row"><label>ComboOverlap</label><input type="number" id="fComboOverlap" value="0"></div>
            </div>
          </div>
        </div>

        <!-- MANIA -->
        <div class="panelBody" id="tab-mania" style="display:none">
          <div class="groupTitle">♦ Active keymodes</div>

          <div class="inline" style="gap:14px; margin-bottom:6px;">
            <span class="pill" style="display:flex; align-items:center; gap:10px;">
              <span class="switchLabel">4K</span>
              <label class="switch" title="Enable 4K block">
                <input type="checkbox" id="km4" checked>
                <span class="sw"></span>
              </label>
            </span>

            <span class="pill" style="display:flex; align-items:center; gap:10px;">
              <span class="switchLabel">6K</span>
              <label class="switch" title="Enable 6K block">
                <input type="checkbox" id="km6">
                <span class="sw"></span>
              </label>
            </span>

            <span class="pill" style="display:flex; align-items:center; gap:10px;">
              <span class="switchLabel">7K</span>
              <label class="switch" title="Enable 7K block">
                <input type="checkbox" id="km7">
                <span class="sw"></span>
              </label>
            </span>
          </div>

          <div class="mini">*skin.ini will include only enabled modes.</div>

          <div class="sep"></div>

          <!-- per-mode blocks injected here -->
          <div id="modesContainer"></div>

          <div class="sep"></div>
          <div class="groupTitle">♦ Colours (shared)</div>

          <div class="row">
            <label>Colour (all keys)</label>
            <div class="inline">
              <input type="color" id="mKeyColourPick">
              <input type="text" id="mKeyColour" placeholder="0,0,0,200">
            </div>
          </div>

          <div class="row">
            <label>ColourHold</label>
            <div class="inline"><input type="color" id="mHoldPick"><input type="text" id="mColourHold" placeholder="255,255,255"></div>
          </div>
          <div class="row">
            <label>ColourBreak</label>
            <div class="inline"><input type="color" id="mBreakPick"><input type="text" id="mColourBreak" placeholder="0,0,0"></div>
          </div>

          <div class="sep"></div>
          <div class="groupTitle">♦ Judgements (shared)</div>
          <div class="grid2">
            <div class="row"><label>Hit0</label><input type="text" id="h0"></div>
            <div class="row"><label>Hit50</label><input type="text" id="h50"></div>
            <div class="row"><label>Hit100</label><input type="text" id="h100"></div>
            <div class="row"><label>Hit200</label><input type="text" id="h200"></div>
            <div class="row"><label>Hit300</label><input type="text" id="h300"></div>
            <div class="row"><label>Hit300g</label><input type="text" id="h300g"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT PREVIEW -->
      <div class="panel">
        <div class="panelHead">
          <div class="mini">skin.ini preview</div>
          <div class="mini">Mania: Enabled 4K/6K/7K only</div>
        </div>
        <div class="panelBody">
          <textarea id="preview" readonly></textarea>
          <p class="hint">This is exactly what will be downloaded as skin.ini.</p>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const STORAGE_KEY = "aeditor_skinini_builder_v8_patterns_per_mode";

const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const bool01 = (b)=> (b ? "1" : "0");
function cleanLine(s){ return String(s??"").replace(/\r/g,"").trimEnd(); }

/* Pretty formatting toggle */
let prettyFormat = true;

/* Key/value formatting */
function fmtKV(key, value){
  const v = cleanLine(value);
  if(prettyFormat){
    const k = String(key).padEnd(32, " ");
    return `${k} : ${v}`;
  }
  return `${key}: ${v}`;
}
function pushIfFmt(arr, key, value){
  const v = cleanLine(value);
  if(v !== "") arr.push(fmtKV(key, v));
}
function spacer(arr){
  if(prettyFormat) arr.push("");
}
function header(arr, title){
  if(prettyFormat){
    arr.push(`// ${title} --`);
    arr.push("");
  }
}

function rgbToHex(rgb){
  const m = String(rgb||"").match(/^\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*$/);
  if(!m) return null;
  const r = clamp(parseInt(m[1],10),0,255);
  const g = clamp(parseInt(m[2],10),0,255);
  const b = clamp(parseInt(m[3],10),0,255);
  return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
}
function hexToRgb(hex){
  const h = String(hex||"").replace("#","").trim();
  if(!/^[0-9a-fA-F]{6}$/.test(h)) return "";
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `${r},${g},${b}`;
}
function bindColourSync(pickId, textId){
  const pick = $(pickId);
  const txt = $(textId);
  const hx = rgbToHex(txt.value);
  if(hx) pick.value = hx;

  pick.addEventListener("input", ()=>{
    txt.value = hexToRgb(pick.value);
    scheduleUpdate();
  });
  txt.addEventListener("input", ()=>{
    const hx2 = rgbToHex(txt.value);
    if(hx2) pick.value = hx2;
    scheduleUpdate();
  });
}

function csvRepeat(value, count){
  return Array.from({length: count}, ()=>String(value)).join(",");
}
function csvBetween(value, keys){
  return csvRepeat(value, Math.max(0, keys-1));
}
function pat(pattern, n){
  const p = String(pattern||"").trim();
  if(!p) return "";
  return p.replaceAll("{n}", String(n));
}

/* tabs */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  $("tab-general").style.display = (name==="general") ? "block" : "none";
  $("tab-mania").style.display   = (name==="mania") ? "block" : "none";
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});

/* -------------------------
   Mania per-keymode state
-------------------------- */
function defaultMode(keys){
  return {
    mColWidth: "70",
    mColSpacing: "0",
    mAutoCenter: true,
    mARPreset: "16:9",
    mARW: "16",
    mARH: "9",
    mCenterOffset: "0",

    mHitPos: "",
    mScorePos: "200",
    mComboPos: "160",

    mJudgementLine: false,
    mUpsideDown: false,
    mKeysUnderNotes: false,

    mBarlineHeight: value="0",
    mNoteHeightScale: "",
    mLightPos: value"0",

    mStageLeft: "",
    mStageRight: "",
    mStageBottom: "",
    mStageHint: "",
    mStageLight: "",

    mLightNWidth: "",
    mLightLWidth: "",
    mLightingN: "",
    mLightingL: "",

    /* patterns per keymode */
    pKey: "",
    pKeyD: "",
    pNote: "",
    pNoteH: "",
    pNoteL: "",
    pNoteT: "",
    mWarningArrow: ""
  };
}

const maniaModes = {
  4: defaultMode(4),
  6: defaultMode(6),
  7: defaultMode(7),
};

/* enabled keymodes (4/6/7 only) */
let enabledModes = {4:true,6:false,7:false};

function modeId(base, keys){ return `${base}_${keys}`; }

function renderModeBlock(keys){
  return `
    <div class="modeBlock" data-keys="${keys}">
      <div class="modeHead">
        <div class="modeTag">${keys}K settings</div>
        <div class="mini">Only this block affects ${keys}K.</div>
      </div>

      <div class="groupTitle">♦ Essentials (${keys}K)</div>
      <div class="row"><label>ColumnWidth (per col)</label><input type="number" id="${modeId("mColWidth",keys)}" value="70"></div>
      <div class="row"><label>ColumnSpacing (between)</label><input type="number" id="${modeId("mColSpacing",keys)}" value="0"></div>

      <div class="row">
        <label>Auto-center ColumnStart</label>
        <div class="inline">
          <label class="switch"><input type="checkbox" id="${modeId("mAutoCenter",keys)}" checked><span class="sw"></span></label>
        </div>
      </div>

      <div class="row">
        <label>Aspect ratio</label>
        <div class="inline">
          <select id="${modeId("mARPreset",keys)}">
            <option value="16:9" selected>16:9</option>
            <option value="4:3">4:3</option>
            <option value="21:9">21:9</option>
            <option value="custom">Custom</option>
          </select>
          <input type="number" id="${modeId("mARW",keys)}" value="16" style="max-width:110px" title="Custom width">
          <input type="number" id="${modeId("mARH",keys)}" value="9" style="max-width:110px" title="Custom height">
          <span class="mini">AR = W/H</span>
        </div>
      </div>

      <div class="row"><label>Fine adjust (px)</label><input type="number" id="${modeId("mCenterOffset",keys)}" value="0"></div>

      <div class="row"><label>HitPosition</label><input type="number" id="${modeId("mHitPos",keys)}" value="402"></div>
      <div class="row"><label>ScorePosition</label><input type="number" id="${modeId("mScorePos",keys)}" value="260"></div>
      <div class="row"><label>ComboPosition</label><input type="number" id="${modeId("mComboPos",keys)}" value="240"></div>

      <div class="row">
        <label>JudgementLine</label>
        <div class="inline"><label class="switch"><input type="checkbox" id="${modeId("mJudgementLine",keys)}" checked><span class="sw"></span></label></div>
      </div>
      <div class="row">
        <label>UpsideDown</label>
        <div class="inline"><label class="switch"><input type="checkbox" id="${modeId("mUpsideDown",keys)}"><span class="sw"></span></label></div>
      </div>
      <div class="row">
        <label>KeysUnderNotes</label>
        <div class="inline"><label class="switch"><input type="checkbox" id="${modeId("mKeysUnderNotes",keys)}"><span class="sw"></span></label></div>
      </div>

      <div class="sep"></div>
      <div class="groupTitle">♦ Reading refinements (${keys}K)</div>
      <div class="row"><label>BarlineHeight</label><input type="number" id="${modeId("mBarlineHeight",keys)}" value=""></div>
      <div class="row"><label>WidthForNoteHeightScale</label><input type="number" id="${modeId("mNoteHeightScale",keys)}" value=""></div>
      <div class="row"><label>LightPosition</label><input type="number" id="${modeId("mLightPos",keys)}" value=""></div>

      <div class="sep"></div>
      <div class="groupTitle">♦ Stage / Lighting (${keys}K)</div>
      <div class="grid2">
        <div>
          <div class="row"><label>StageLeft</label><input type="text" id="${modeId("mStageLeft",keys)}"></div>
          <div class="row"><label>StageRight</label><input type="text" id="${modeId("mStageRight",keys)}"></div>
          <div class="row"><label>StageBottom</label><input type="text" id="${modeId("mStageBottom",keys)}"></div>
          <div class="row"><label>StageHint</label><input type="text" id="${modeId("mStageHint",keys)}"></div>
          <div class="row"><label>StageLight</label><input type="text" id="${modeId("mStageLight",keys)}"></div>
        </div>
        <div>
          <div class="row"><label>LightingNWidth</label><input type="number" id="${modeId("mLightNWidth",keys)}"></div>
          <div class="row"><label>LightingLWidth</label><input type="number" id="${modeId("mLightLWidth",keys)}"></div>
          <div class="row"><label>LightingN</label><input type="text" id="${modeId("mLightingN",keys)}"></div>
          <div class="row"><label>LightingL</label><input type="text" id="${modeId("mLightingL",keys)}"></div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="groupTitle">♦ Images (patterns) (${keys}K)</div>
      <div class="mini">
        skin.ini indexes are <span class="kbd">0..Keys-1</span>, but <span class="kbd">{n}</span> stays <span class="kbd">1..Keys</span> for filenames.
        Example: <span class="kbd">key{n}</span>.
      </div>

      <div class="grid2" style="margin-top:8px">
        <div>
          <div class="row"><label>KeyImage# pattern</label><input type="text" id="${modeId("pKey",keys)}" placeholder=""></div>
          <div class="row"><label>KeyImage#D pattern</label><input type="text" id="${modeId("pKeyD",keys)}" placeholder=""></div>
        </div>
        <div>
          <div class="row"><label>NoteImage# pattern</label><input type="text" id="${modeId("pNote",keys)}" placeholder=""></div>
          <div class="row"><label>NoteImage#H pattern</label><input type="text" id="${modeId("pNoteH",keys)}" placeholder=""></div>
        </div>
      </div>

      <div class="grid2">
        <div>
          <div class="row"><label>NoteImage#L pattern</label><input type="text" id="${modeId("pNoteL",keys)}" placeholder=""></div>
          <div class="row"><label>NoteImage#T pattern</label><input type="text" id="${modeId("pNoteT",keys)}" placeholder=""></div>
        </div>
        <div class="row" style="grid-template-columns:190px 1fr;">
          <label>WarningArrow</label><input type="text" id="${modeId("mWarningArrow",keys)}">
        </div>
      </div>
    </div>
  `;
}

function applyModeToUI(keys, mode){
  $(modeId("mColWidth",keys)).value = mode.mColWidth ?? "70";
  $(modeId("mColSpacing",keys)).value = mode.mColSpacing ?? "0";
  $(modeId("mAutoCenter",keys)).checked = !!mode.mAutoCenter;

  $(modeId("mARPreset",keys)).value = mode.mARPreset ?? "16:9";
  $(modeId("mARW",keys)).value = mode.mARW ?? "16";
  $(modeId("mARH",keys)).value = mode.mARH ?? "9";
  $(modeId("mCenterOffset",keys)).value = mode.mCenterOffset ?? "0";

  $(modeId("mHitPos",keys)).value = mode.mHitPos ?? "460";
  $(modeId("mScorePos",keys)).value = mode.mScorePos ?? "200";
  $(modeId("mComboPos",keys)).value = mode.mComboPos ?? "160";

  $(modeId("mJudgementLine",keys)).checked = (mode.mJudgementLine ?? true);
  $(modeId("mUpsideDown",keys)).checked = !!mode.mUpsideDown;
  $(modeId("mKeysUnderNotes",keys)).checked = !!mode.mKeysUnderNotes;

  $(modeId("mBarlineHeight",keys)).value = mode.mBarlineHeight ?? "";
  $(modeId("mNoteHeightScale",keys)).value = mode.mNoteHeightScale ?? "";
  $(modeId("mLightPos",keys)).value = mode.mLightPos ?? "";

  $(modeId("mStageLeft",keys)).value = mode.mStageLeft ?? "";
  $(modeId("mStageRight",keys)).value = mode.mStageRight ?? "";
  $(modeId("mStageBottom",keys)).value = mode.mStageBottom ?? "";
  $(modeId("mStageHint",keys)).value = mode.mStageHint ?? "";
  $(modeId("mStageLight",keys)).value = mode.mStageLight ?? "";

  $(modeId("mLightNWidth",keys)).value = mode.mLightNWidth ?? "";
  $(modeId("mLightLWidth",keys)).value = mode.mLightLWidth ?? "";
  $(modeId("mLightingN",keys)).value = mode.mLightingN ?? "";
  $(modeId("mLightingL",keys)).value = mode.mLightingL ?? "";

  /* patterns */
  $(modeId("pKey",keys)).value = mode.pKey ?? "key{n}";
  $(modeId("pKeyD",keys)).value = mode.pKeyD ?? "key{n}D";
  $(modeId("pNote",keys)).value = mode.pNote ?? "note{n}";
  $(modeId("pNoteH",keys)).value = mode.pNoteH ?? "note{n}H";
  $(modeId("pNoteL",keys)).value = mode.pNoteL ?? "note{n}L";
  $(modeId("pNoteT",keys)).value = mode.pNoteT ?? "note{n}T";
  $(modeId("mWarningArrow",keys)).value = mode.mWarningArrow ?? "";
}

function readModeFromUI(keys){
  return {
    mColWidth: $(modeId("mColWidth",keys)).value,
    mColSpacing: $(modeId("mColSpacing",keys)).value,
    mAutoCenter: $(modeId("mAutoCenter",keys)).checked,
    mARPreset: $(modeId("mARPreset",keys)).value,
    mARW: $(modeId("mARW",keys)).value,
    mARH: $(modeId("mARH",keys)).value,
    mCenterOffset: $(modeId("mCenterOffset",keys)).value,

    mHitPos: $(modeId("mHitPos",keys)).value,
    mScorePos: $(modeId("mScorePos",keys)).value,
    mComboPos: $(modeId("mComboPos",keys)).value,

    mJudgementLine: $(modeId("mJudgementLine",keys)).checked,
    mUpsideDown: $(modeId("mUpsideDown",keys)).checked,
    mKeysUnderNotes: $(modeId("mKeysUnderNotes",keys)).checked,

    mBarlineHeight: $(modeId("mBarlineHeight",keys)).value,
    mNoteHeightScale: $(modeId("mNoteHeightScale",keys)).value,
    mLightPos: $(modeId("mLightPos",keys)).value,

    mStageLeft: $(modeId("mStageLeft",keys)).value,
    mStageRight: $(modeId("mStageRight",keys)).value,
    mStageBottom: $(modeId("mStageBottom",keys)).value,
    mStageHint: $(modeId("mStageHint",keys)).value,
    mStageLight: $(modeId("mStageLight",keys)).value,

    mLightNWidth: $(modeId("mLightNWidth",keys)).value,
    mLightLWidth: $(modeId("mLightLWidth",keys)).value,
    mLightingN: $(modeId("mLightingN",keys)).value,
    mLightingL: $(modeId("mLightingL",keys)).value,

    /* patterns */
    pKey: $(modeId("pKey",keys)).value,
    pKeyD: $(modeId("pKeyD",keys)).value,
    pNote: $(modeId("pNote",keys)).value,
    pNoteH: $(modeId("pNoteH",keys)).value,
    pNoteL: $(modeId("pNoteL",keys)).value,
    pNoteT: $(modeId("pNoteT",keys)).value,
    mWarningArrow: $(modeId("mWarningArrow",keys)).value
  };
}

function rerenderModes(){
  const cont = $("modesContainer");
  const active = [4,6,7].filter(k => enabledModes[k]);

  cont.innerHTML = active.map(k => renderModeBlock(k)).join("");

  for(const k of active){
    applyModeToUI(k, maniaModes[k] || defaultMode(k));
  }
}

function getAspectRatio(mode){
  const preset = mode.mARPreset;
  let w = Number(mode.mARW || 16);
  let h = Number(mode.mARH || 9);

  if(preset !== "custom"){
    const [pw,ph] = preset.split(":").map(Number);
    if(Number.isFinite(pw) && Number.isFinite(ph) && ph !== 0){
      w = pw; h = ph;
    }
  }
  if(!Number.isFinite(w) || !Number.isFinite(h) || h === 0) return 16/9;
  return w / h;
}

function calcColumnStart(keys, colWidth, colSpacing, aspectRatio, offset){
  const usableWidth = 480 * aspectRatio;
  const columnSum = (colWidth * keys) + (colSpacing * (keys - 1));
  return Math.round((usableWidth/2) - (columnSum/2)) + Number(offset || 0);
}

/* ini gen */
function maniaBlockForKeys(keys){
  const mode = maniaModes[keys] || defaultMode(keys);
  const lines = [];

  const colW = Number(mode.mColWidth || 0);
  const colS = Number(mode.mColSpacing || 0);
  const ar = getAspectRatio(mode);
  const autoCenter = !!mode.mAutoCenter;
  const offset = Number(mode.mCenterOffset || 0);

  lines.push(fmtKV("Keys", keys));
  spacer(lines);

  lines.push(fmtKV("ColumnWidth", csvRepeat(colW, keys)));
  lines.push(fmtKV("ColumnSpacing", csvBetween(colS, keys)));
  spacer(lines);

  if(autoCenter){
    lines.push(fmtKV("ColumnStart", calcColumnStart(keys, colW, colS, ar, offset)));
  }

  pushIfFmt(lines, "HitPosition", mode.mHitPos);
  pushIfFmt(lines, "ScorePosition", mode.mScorePos);
  pushIfFmt(lines, "ComboPosition", mode.mComboPos);
  spacer(lines);

  lines.push(fmtKV("JudgementLine", bool01(!!mode.mJudgementLine)));
  spacer(lines);

  lines.push(fmtKV("UpsideDown", bool01(!!mode.mUpsideDown)));
  spacer(lines);

  lines.push(fmtKV("KeysUnderNotes", bool01(!!mode.mKeysUnderNotes)));
  spacer(lines);

  lines.push(fmtKV("ColumnLineWidth", csvRepeat(0, keys + 1)));
  pushIfFmt(lines, "BarlineHeight", mode.mBarlineHeight);
  pushIfFmt(lines, "WidthForNoteHeightScale", mode.mNoteHeightScale);
  pushIfFmt(lines, "LightPosition", mode.mLightPos);
  spacer(lines);

  header(lines, "stage");
  pushIfFmt(lines, "StageLeft", mode.mStageLeft);
  pushIfFmt(lines, "StageRight", mode.mStageRight);
  pushIfFmt(lines, "StageBottom", mode.mStageBottom);
  pushIfFmt(lines, "StageHint", mode.mStageHint);
  pushIfFmt(lines, "StageLight", mode.mStageLight);
  pushIfFmt(lines, "LightingNWidth", mode.mLightNWidth);
  pushIfFmt(lines, "LightingLWidth", mode.mLightLWidth);
  pushIfFmt(lines, "LightingN", mode.mLightingN);
  pushIfFmt(lines, "LightingL", mode.mLightingL);
  spacer(lines);

  pushIfFmt(lines, "ColourHold", $("mColourHold").value);
  pushIfFmt(lines, "ColourBreak", $("mColourBreak").value);
  spacer(lines);

  const keyColour = cleanLine($("mKeyColour").value);
  if(keyColour){
    for(let idx=0; idx<keys; idx++) lines.push(fmtKV(`Colour${idx}`, keyColour));
    spacer(lines);
  }

  /* patterns per-mode */
  const pKey = mode.pKey || "";
  const pKeyD = mode.pKeyD || "";
  const pNote = mode.pNote || "";
  const pNoteH = mode.pNoteH || "";
  const pNoteL = mode.pNoteL || "";
  const pNoteT = mode.pNoteT || "";

  header(lines, "keys");
  for(let idx=0; idx<keys; idx++){
    const n = idx + 1;
    const a = pat(pKey, n); if(a) lines.push(fmtKV(`KeyImage${idx}`, a));
  }
  spacer(lines);
  for(let idx=0; idx<keys; idx++){
    const n = idx + 1;
    const a = pat(pKeyD, n); if(a) lines.push(fmtKV(`KeyImage${idx}D`, a));
  }
  spacer(lines);

  header(lines, "notes");
  for(let idx=0; idx<keys; idx++){
    const n = idx + 1;
    const a = pat(pNote, n); if(a) lines.push(fmtKV(`NoteImage${idx}`, a));
  }
  spacer(lines);
  for(let idx=0; idx<keys; idx++){
    const n = idx + 1;
    const a = pat(pNoteH, n); if(a) lines.push(fmtKV(`NoteImage${idx}H`, a));
  }
  spacer(lines);

  header(lines, "ln");
  for(let idx=0; idx<keys; idx++){
    const n = idx + 1;
    const a = pat(pNoteL, n); if(a) lines.push(fmtKV(`NoteImage${idx}L`, a));
  }
  spacer(lines);
  for(let idx=0; idx<keys; idx++){
    const n = idx + 1;
    const a = pat(pNoteT, n); if(a) lines.push(fmtKV(`NoteImage${idx}T`, a));
  }
  spacer(lines);

  pushIfFmt(lines, "WarningArrow", mode.mWarningArrow);
  spacer(lines);

  header(lines, "hits");
  pushIfFmt(lines, "Hit0", $("h0").value);
  pushIfFmt(lines, "Hit50", $("h50").value);
  pushIfFmt(lines, "Hit100", $("h100").value);
  pushIfFmt(lines, "Hit200", $("h200").value);
  pushIfFmt(lines, "Hit300", $("h300").value);
  pushIfFmt(lines, "Hit300g", $("h300g").value);

  while(lines.length && lines[lines.length-1] === "") lines.pop();
  return lines;
}

function genIni(){
  const out = [];

  out.push("[General]");
  pushIfFmt(out, "Name", $("gName").value);
  pushIfFmt(out, "Author", $("gAuthor").value);
  out.push(fmtKV("Version", "latest"));
  pushIfFmt(out, "CursorCentre", bool01($("gCursorCentre").checked));
  pushIfFmt(out, "CursorExpand", bool01($("gCursorExpand").checked));
  pushIfFmt(out, "CursorRotate", bool01($("gCursorRotate").checked));
  pushIfFmt(out, "CursorTrailRotate", bool01($("gCursorTrailRotate").checked));
  out.push("");

  const hasColours = cleanLine($("cMenuGlow").value) || cleanLine($("cSongActive").value) || cleanLine($("cSongInactive").value);
  if(hasColours){
    out.push("[Colours]");
    pushIfFmt(out, "MenuGlow", $("cMenuGlow").value);
    pushIfFmt(out, "SongSelectActiveText", $("cSongActive").value);
    pushIfFmt(out, "SongSelectInactiveText", $("cSongInactive").value);
    out.push("");
  }

  const hasFonts = cleanLine($("fScorePrefix").value) || cleanLine($("fComboPrefix").value) || cleanLine($("fScoreOverlap").value) || cleanLine($("fComboOverlap").value);
  if(hasFonts){
    out.push("[Fonts]");
    pushIfFmt(out, "ScorePrefix", $("fScorePrefix").value);
    pushIfFmt(out, "ScoreOverlap", $("fScoreOverlap").value);
    pushIfFmt(out, "ComboPrefix", $("fComboPrefix").value);
    pushIfFmt(out, "ComboOverlap", $("fComboOverlap").value);
    out.push("");
  }

  for(const keys of [4,6,7]){
    if(!enabledModes[keys]) continue;
    out.push("[Mania]");
    out.push(...maniaBlockForKeys(keys));
    out.push("");
  }

  while(out.length && out[out.length-1] === "") out.pop();
  return out.join("\n");
}

/* autosave */
let saveTimer = null;

function saveAllActiveModesIntoState(){
  for(const keys of [4,6,7]){
    if(!enabledModes[keys]) continue;
    const block = document.querySelector(`.modeBlock[data-keys="${keys}"]`);
    if(block){
      maniaModes[keys] = readModeFromUI(keys);
    }
  }
}

function saveState(){
  saveAllActiveModesIntoState();

  const s = {
    prettyFormat: !!prettyFormat,
    enabledModes: { ...enabledModes },

    gName: $("gName").value,
    gAuthor: $("gAuthor").value,

    gCursorCentre: $("gCursorCentre").checked,
    gCursorExpand: $("gCursorExpand").checked,
    gCursorRotate: $("gCursorRotate").checked,
    gCursorTrailRotate: $("gCursorTrailRotate").checked,

    cMenuGlow: $("cMenuGlow").value,
    cSongActive: $("cSongActive").value,
    cSongInactive: $("cSongInactive").value,

    fScorePrefix: $("fScorePrefix").value,
    fScoreOverlap: $("fScoreOverlap").value,
    fComboPrefix: $("fComboPrefix").value,
    fComboOverlap: $("fComboOverlap").value,

    mKeyColour: $("mKeyColour").value,
    mColourHold: $("mColourHold").value,
    mColourBreak: $("mColourBreak").value,

    h0: $("h0").value,
    h50: $("h50").value,
    h100: $("h100").value,
    h200: $("h200").value,
    h300: $("h300").value,
    h300g: $("h300g").value,

    maniaModes: maniaModes
  };

  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    $("savePulse").textContent = "Saved";
    setTimeout(()=>{ $("savePulse").textContent=""; }, 700);
  }catch(e){}
}

function loadState(){
  let raw=null;
  try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
  if(!raw) return;

  try{
    const s = JSON.parse(raw);
    if(!s) return;

    prettyFormat = (s.prettyFormat ?? true) ? true : false;
    $("prettyFormat").checked = prettyFormat;

    if(s.enabledModes && typeof s.enabledModes === "object"){
      enabledModes = {
        4: (s.enabledModes[4] ?? true) ? true : false,
        6: !!s.enabledModes[6],
        7: !!s.enabledModes[7]
      };
    }

    $("km4").checked = !!enabledModes[4];
    $("km6").checked = !!enabledModes[6];
    $("km7").checked = !!enabledModes[7];

    $("gName").value = s.gName ?? "";
    $("gAuthor").value = s.gAuthor ?? "";

    $("gCursorCentre").checked = !!s.gCursorCentre;
    $("gCursorExpand").checked = !!s.gCursorExpand;
    $("gCursorRotate").checked = !!s.gCursorRotate;
    $("gCursorTrailRotate").checked = !!s.gCursorTrailRotate;

    $("cMenuGlow").value = s.cMenuGlow ?? "";
    $("cSongActive").value = s.cSongActive ?? "";
    $("cSongInactive").value = s.cSongInactive ?? "";

    $("fScorePrefix").value = s.fScorePrefix ?? "";
    $("fScoreOverlap").value = s.fScoreOverlap ?? "0";
    $("fComboPrefix").value = s.fComboPrefix ?? "";
    $("fComboOverlap").value = s.fComboOverlap ?? "0";

    $("mKeyColour").value = s.mKeyColour ?? "";
    $("mColourHold").value = s.mColourHold ?? "";
    $("mColourBreak").value = s.mColourBreak ?? "";

    $("h0").value = s.h0 ?? "";
    $("h50").value = s.h50 ?? "";
    $("h100").value = s.h100 ?? "";
    $("h200").value = s.h200 ?? "";
    $("h300").value = s.h300 ?? "";
    $("h300g").value = s.h300g ?? "";

    if(s.maniaModes && typeof s.maniaModes === "object"){
      for(const k of ["4","6","7"]){
        if(s.maniaModes[k]) maniaModes[Number(k)] = s.maniaModes[k];
      }
    }
  }catch(e){}
}

/* live update */
function updatePreview(){
  saveAllActiveModesIntoState();
  $("preview").value = genIni();
}
function scheduleUpdate(){
  updatePreview();
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveState, 250);
}

/* actions */
function downloadIni(){
  const text = $("preview").value;
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "skin.ini";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function clearWipe(){
  if(!confirm("Clear everything (and remove local autosave)?")) return;
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  location.reload();
}
$("downloadIni").addEventListener("click", downloadIni);
$("clearWipe").addEventListener("click", clearWipe);

/* pretty toggle */
$("prettyFormat").addEventListener("change", ()=>{
  prettyFormat = $("prettyFormat").checked;
  scheduleUpdate();
});

/* keymode toggles */
function onToggleModes(){
  saveAllActiveModesIntoState();

  enabledModes[4] = $("km4").checked;
  enabledModes[6] = $("km6").checked;
  enabledModes[7] = $("km7").checked;

  rerenderModes();
  scheduleUpdate();
}
$("km4").addEventListener("change", onToggleModes);
$("km6").addEventListener("change", onToggleModes);
$("km7").addEventListener("change", onToggleModes);

/* input delegation for dynamic mode blocks */
$("tab-mania").addEventListener("input", ()=>{
  scheduleUpdate();
});
$("tab-mania").addEventListener("change", ()=>{
  scheduleUpdate();
});

/* binds for general/static inputs */
[
  "gName","gAuthor",
  "gCursorCentre","gCursorExpand","gCursorRotate","gCursorTrailRotate",
  "cMenuGlow","cSongActive","cSongInactive",
  "fScorePrefix","fScoreOverlap","fComboPrefix","fComboOverlap",

  "mKeyColour","mColourHold","mColourBreak",
  "h0","h50","h100","h200","h300","h300g"
].forEach(id=>{
  $(id).addEventListener("input", scheduleUpdate);
  $(id).addEventListener("change", scheduleUpdate);
});

/* Colour sync */
bindColourSync("cMenuGlowPick","cMenuGlow");
bindColourSync("cSongActivePick","cSongActive");
bindColourSync("cSongInactivePick","cSongInactive");
bindColourSync("mKeyColourPick","mKeyColour");
bindColourSync("mHoldPick","mColourHold");
bindColourSync("mBreakPick","mColourBreak");

function seedDefaultsIfEmpty(){
  if(!$("cMenuGlow").value) $("cMenuGlow").value = "255,255,255";
  if(!$("cSongActive").value) $("cSongActive").value = "255,255,255";
  if(!$("cSongInactive").value) $("cSongInactive").value = "160,160,160";

  if(!$("mKeyColour").value) $("mKeyColour").value = "255,255,255";
  if(!$("mColourHold").value) $("mColourHold").value = "255,255,255";
  if(!$("mColourBreak").value) $("mColourBreak").value = "255,80,80";
}

/* init */
loadState();
seedDefaultsIfEmpty();
rerenderModes();
updatePreview();
</script>

<script src="snow.js?v=1"></script>
</body>
</html>
