<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>skin.ini studio</title>
  <link rel="icon" type="image/png" href="https://i.pinimg.com/1200x/d6/ca/e4/d6cae471e8471dec46c4304104adb4b1.jpg"/>

  <style>
    :root{
      --fg:#e9e9ee;
      --muted:rgba(233,233,238,.62);
      --muted2:rgba(233,233,238,.40);
      --border:rgba(255,255,255,.12);
      --panel:rgba(0,0,0,.44);
      --panel2:rgba(0,0,0,.28);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --r:14px;

      --dockW:62px;
      --gap:10px;

      --rowLabel: 205px; /* compacto mas clic√°vel */
      --inputPadY: 9px;
      --inputPadX: 10px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:var(--fg);
      font: 14px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;

      /* fundo pedido */
      background-image: url("https://i.pinimg.com/originals/f5/93/a4/f593a4f4932080fb7b43c6ae96d1a73d.gif");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      overflow:hidden;
    }

    /* overlay pra legibilidade */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(0,0,0,.25), transparent 55%),
        radial-gradient(900px 520px at 85% 20%, rgba(0,0,0,.25), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.66), rgba(0,0,0,.62));
      backdrop-filter: blur(2px);
    }

    /* Scrollbar */
    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(220,220,230,.30) rgba(0,0,0,.20);
    }
    *::-webkit-scrollbar{ width:10px; height:10px; }
    *::-webkit-scrollbar-track{ background: rgba(0,0,0,.20); border-radius: 10px; }
    *::-webkit-scrollbar-thumb{
      background: rgba(220,220,230,.26);
      border: 2px solid rgba(0,0,0,.20);
      border-radius: 10px;
    }
    *::-webkit-scrollbar-thumb:hover{ background: rgba(220,220,230,.40); }

    .app{
      position:relative;
      z-index:1;
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .brand img{
      width:30px;
      height:30px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      object-fit: cover;
    }
    .brand .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .brand .title b{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .title span{
      font-size:12px;
      color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .layout{
      flex:1; min-height:0;
      display:grid;
      grid-template-columns: var(--dockW) 1fr;
      overflow:hidden;
    }

    /* ===== Sidebar dock (Opera GX vibes) ===== */
    .dock{
      border-right:1px solid var(--border);
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:10px 8px;
      min-height:0;
      overflow:auto;
    }

    .dockGroup{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .dockGroup:last-child{ border-bottom:0; padding-bottom:0; }

    .icoBtn{
      width:46px;
      height:46px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.78);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition:140ms linear;
      position:relative;
    }
    .icoBtn:hover{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(233,233,238,.95);
      transform: translateY(-1px);
    }
    .icoBtn.active{
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color: rgba(233,233,238,.98);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .tip{
      position:absolute;
      left:58px;
      top:50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:6px 10px;
      font-size:12px;
      color: rgba(233,233,238,.92);
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition:140ms linear;
      backdrop-filter: blur(10px);
    }
    .icoBtn:hover .tip{ opacity:1; }

    .miniLabel{
      font-size:11px;
      color: var(--muted2);
      text-align:center;
      line-height:1.2;
    }

    /* ===== Main content ===== */
    .main{
      min-height:0;
      padding:10px;
      display:grid;
      grid-template-columns: 1.12fr .88fr;
      gap:10px;
      overflow:hidden;
    }

    .card{
      border:1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .cardHead{
      padding:10px 10px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    .cardHead .left{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.75);
      font-weight:900;
    }
    .tools{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .cardBody{
      padding:10px;
      overflow:auto;
      min-height:0;
      flex:1;
    }

    .btn{
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.78);
      font-weight:900;
      transition:140ms linear;
      user-select:none;
    }
    .btn:hover{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(233,233,238,.95);
    }
    .btn.primary{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      color: rgba(233,233,238,.95);
    }
    .btn.danger:hover{
      border-color: rgba(255,140,140,.35);
      color: rgba(255,220,220,.95);
    }

    textarea{
      width:100%;
      min-height: calc(100vh - 220px);
      resize:none;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.30);
      color: rgba(233,233,238,.95);
      padding:10px 12px;
      outline:none;
      font:inherit;
    }

    /* ===== Forms (compact but clickable) ===== */
    .block{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      overflow:hidden;
      margin: 10px 0;
    }
    .blockHead{
      width:100%;
      border:0;
      cursor:pointer;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.22);
      color: rgba(233,233,238,.95);
      font:inherit;
      font-weight: 900;
      letter-spacing:.2px;
      user-select:none;
    }
    .caret{
      color: rgba(233,233,238,.60);
      transition:140ms linear;
    }
    .block.open .caret{ transform: rotate(90deg); }
    .blockBody{
      display:none;
      padding:10px 12px 12px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .block.open .blockBody{ display:block; }

    .row{
      display:grid;
      grid-template-columns: var(--rowLabel) 1fr;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
    }
    .row label{
      font-size:12px;
      color: rgba(233,233,238,.80);
      font-weight:900;
      user-select:none;
    }

    input[type="text"], input[type="number"], select{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: rgba(0,0,0,.26);
      color: rgba(233,233,238,.95);
      padding: var(--inputPadY) var(--inputPadX);
      outline:none;
      font:inherit;
    }

    input[type="color"]{
      width:46px; height:38px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background:transparent;
      padding:0;
    }

    .inline{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .sep{ height:1px; background: rgba(255,255,255,.10); margin:10px 0; }

    /* switch */
    .switch{ display:inline-flex; align-items:center; gap:8px; }
    .switch input{ display:none; }
    .sw{
      width:48px; height:28px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.24);
      border-radius: 12px;
      position:relative;
      transition:140ms linear;
      flex:0 0 auto;
      cursor:pointer;
    }
    .sw::after{
      content:"";
      width:22px; height:22px;
      position:absolute; top:50%; left:3px;
      transform: translateY(-50%);
      border-radius: 9px;
      background: rgba(255,255,255,.28);
      transition:140ms linear;
    }
    .switch input:checked + .sw{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
    }
    .switch input:checked + .sw::after{
      left:23px;
      background: rgba(255,255,255,.62);
    }

    .noteUnder{
      margin-top:6px;
      font-size:12px;
      color: rgba(233,233,238,.48);
      font-weight:800;
    }

    /* mania keymode toggles */
    .kmRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin: 6px 0 4px;
    }
    .kmPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      font-size:12px;
      font-weight:900;
      color: rgba(233,233,238,.70);
      user-select:none;
    }
    .kmPill.on{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
      color: rgba(233,233,238,.95);
    }

    .disabledHint{
      font-size:12px;
      color: rgba(233,233,238,.55);
      font-weight:900;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .dock{
        flex-direction:row;
        border-right:0;
        border-bottom:1px solid var(--border);
        padding:10px;
        gap:10px;
      }
      .dockGroup{
        flex-direction:row;
        border-bottom:0;
        padding-bottom:0;
        width:auto;
      }
      .icoBtn .tip{ display:none; }
      .main{ grid-template-columns: 1fr; }
      textarea{ min-height: 50vh; }
      .row{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<div class="app">

  <div class="topbar">
    <div class="brand">
      <img alt="icon" src="https://i.pinimg.com/originals/da/b4/cb/dab4cbf31e4e8d7688b0e830d5d640f1.gif">
      <div class="title">
        <b>skin.ini studio</b>
        <span id="topSub">‚Äî</span>
      </div>
    </div>

    <div class="tools">
      <span class="badge" id="savePulse">‚Äî</span>
      <button class="btn primary" id="downloadIni">Download</button>
      <button class="btn" id="copyIni">Copiar</button>
      <button class="btn" id="importOpen">Importar</button>
      <button class="btn danger" id="wipeAll">Reset</button>
    </div>
  </div>

  <div class="layout">
    <aside class="dock">

      <div class="dockGroup">
        <button class="icoBtn" data-tab="general" title="General">
          <span aria-hidden="true">‚öôÔ∏è</span>
          <span class="tip">General</span>
        </button>
        <button class="icoBtn" data-tab="colours" title="Colours">
          <span aria-hidden="true">üé®</span>
          <span class="tip">Colours</span>
        </button>
        <button class="icoBtn" data-tab="fonts" title="Fonts">
          <span aria-hidden="true">üî§</span>
          <span class="tip">Fonts</span>
        </button>
        <button class="icoBtn" data-tab="catch" title="Catch">
          <span aria-hidden="true">üçì</span>
          <span class="tip">Catch</span>
        </button>
        <button class="icoBtn" data-tab="mania" title="Mania">
          <span aria-hidden="true">üéπ</span>
          <span class="tip">Mania</span>
        </button>
        <button class="icoBtn" data-tab="preview" title="Preview">
          <span aria-hidden="true">üëÅÔ∏è</span>
          <span class="tip">Preview</span>
        </button>
      </div>

      <div class="dockGroup">
        <div class="miniLabel">export</div>

        <button class="icoBtn" id="togStd" title="Standard on/off" type="button">
          <span aria-hidden="true">‚≠ï</span>
          <span class="tip">Standard</span>
        </button>
        <button class="icoBtn" id="togCatch" title="Catch on/off" type="button">
          <span aria-hidden="true">üçì</span>
          <span class="tip">Catch</span>
        </button>
        <button class="icoBtn" id="togMania" title="Mania on/off" type="button">
          <span aria-hidden="true">üéπ</span>
          <span class="tip">Mania</span>
        </button>
      </div>

      <div class="dockGroup">
        <div class="miniLabel">style</div>

        <button class="icoBtn" id="togPretty" title="h style" type="button">
          <span aria-hidden="true">H</span>
          <span class="tip">h style</span>
        </button>

        <button class="icoBtn" id="togCommentEmpty" title="comentar vazios" type="button">
          <span aria-hidden="true">//</span>
          <span class="tip">comentar vazios</span>
        </button>
        <div class="noteUnder" id="commentEmptyNote" style="text-align:center; padding:0 6px;">
          *n√£o exportado no skin.ini
        </div>

        <button class="icoBtn" id="verBtn" title="Version" type="button">
          <span aria-hidden="true">v</span>
          <span class="tip">Version</span>
        </button>
      </div>

    </aside>

    <main class="main">

      <div class="card">
        <div class="cardHead">
          <div class="left">
            <span class="badge" id="panelTitle">General</span>
            <span class="badge" id="modeBadge">export: STD+CATCH+MANIA</span>
          </div>
          <div class="tools">
            <button class="btn" id="refresh">Atualizar</button>
          </div>
        </div>
        <div class="cardBody" id="panel"></div>
      </div>

      <div class="card" id="previewCard">
        <div class="cardHead">
          <div class="left">
            <span class="badge">skin.ini</span>
          </div>
          <div class="tools">
            <button class="btn" id="selectAll">Selecionar</button>
          </div>
        </div>
        <div class="cardBody">
          <textarea id="preview" readonly></textarea>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Version modal -->
<dialog id="verDlg" style="max-width:420px;width:calc(100% - 24px);border:1px solid rgba(255,255,255,.14);border-radius:16px;background:rgba(0,0,0,.86);color:rgba(233,233,238,.95);box-shadow:0 20px 60px rgba(0,0,0,.55);">
  <form method="dialog" style="margin:0;padding:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <b>Version</b>
      <button class="btn" value="cancel">Fechar</button>
    </div>
    <div style="height:10px"></div>
    <select id="versionPick" style="width:100%;">
      <option value="2.0">2.0</option>
      <option value="2.1">2.1</option>
      <option value="2.2">2.2</option>
      <option value="2.3">2.3</option>
      <option value="2.4">2.4</option>
      <option value="2.5">2.5</option>
      <option value="2.6">2.6</option>
      <option value="2.7">2.7</option>
      <option value="latest" selected>latest</option>
    </select>
  </form>
</dialog>

<!-- Import modal -->
<dialog id="importDlg" style="max-width:900px;width:calc(100% - 24px);border:1px solid rgba(255,255,255,.14);border-radius:16px;background:rgba(0,0,0,.88);color:rgba(233,233,238,.95);box-shadow:0 20px 60px rgba(0,0,0,.55);">
  <form method="dialog" style="margin:0;padding:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <b>Importar skin.ini</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" value="cancel">Fechar</button>
        <button class="btn primary" id="importApply" value="default" type="button">Aplicar</button>
      </div>
    </div>
    <div style="height:10px"></div>
    <textarea id="importArea" style="min-height:45vh;"></textarea>
  </form>
</dialog>

<script>
/* ===========================
   skin.ini studio (custom)
   - sem textos informativos
   - sem taiko
   - background gif
   - toggles por modo: standard/catch/mania
   - columnstart auto se vazio (n√£o exporta)
   - blocos separados
   - sidebar √≠cones
   - sem m√∫sica
   - cores corrigidas
   - UI Colour 1..K (export continua 0..K-1 por compatibilidade)
   - import mais robusto
=========================== */

const $ = (id)=>document.getElementById(id);
const STORAGE_KEY = "skinini_studio_custom_v4";

/* ---------- util ---------- */
function cleanLine(s){ return String(s ?? "").replace(/\r/g,"").trimEnd(); }
function isBlank(v){ return cleanLine(v) === ""; }
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const bool01 = (b)=> (b ? "1" : "0");

function debounce(fn, wait){
  let t=null;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args), wait);
  };
}

function rgbToHex(rgb){
  const m = String(rgb||"").match(/^\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*$/);
  if(!m) return null;
  const r = clamp(parseInt(m[1],10),0,255);
  const g = clamp(parseInt(m[2],10),0,255);
  const b = clamp(parseInt(m[3],10),0,255);
  return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
}
function hexToRgb(hex){
  const h = String(hex||"").replace("#","").trim();
  if(!/^[0-9a-fA-F]{6}$/.test(h)) return "";
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `${r},${g},${b}`;
}

function fmtKV(key, value){
  const v = cleanLine(value);
  if(state.pretty){
    const k = String(key).padEnd(32, " ");
    return `${k} : ${v}`;
  }
  return `${key}: ${v}`;
}
function pushKV(lines, key, value){
  const v = cleanLine(value);
  if(v !== ""){
    lines.push(fmtKV(key, v));
    return;
  }
  if(state.commentEmpty){
    // coment√°rio de "n√£o exportado": linha comentada (n√£o exporta no sentido de n√£o ser ativa)
    if(state.pretty){
      const k = String(key).padEnd(32, " ");
      lines.push(`// ${k} :`);
    }else{
      lines.push(`//${key}:`);
    }
  }
}
function spacer(lines){ if(state.pretty) lines.push(""); }
function header(lines, title){
  if(state.pretty){
    lines.push(`// ${title} --`);
    lines.push("");
  }
}

/* ---------- state ---------- */
const ALL_MANIA_KEYS = Array.from({length: 18}, (_,i)=>i+1);

function defaultManiaMode(keys){
  return {
    // layout csv / numbers
    ColumnStart: "",       // se vazio: auto (n√£o exporta)
    ColumnRight: "",
    ColumnSpacing: "0",
    ColumnWidth: "70",
    ColumnLineWidth: "",

    // positions
    HitPosition: "",
    LightPosition: "",
    ScorePosition: "",
    ComboPosition: "",

    // toggles
    JudgementLine: true,
    KeysUnderNotes: false,
    UpsideDown: false,

    // misc
    BarlineHeight: "",
    WidthForNoteHeightScale: "",
    LightingNWidth: "",
    LightingLWidth: "",
    LightFramePerSecond: "",
    SpecialStyle: "",
    ComboBurstStyle: "",
    SplitStages: "",
    StageSeparation: "",
    SeparateScore: "",
    KeyFlipWhenUpsideDown: "",
    NoteFlipWhenUpsideDown: "",
    NoteBodyStyle: "",

    // stage/lighting
    StageLeft: "",
    StageRight: "",
    StageBottom: "",
    StageHint: "",
    StageLight: "",
    LightingN: "",
    LightingL: "",

    // colours
    ColourColumnLine: "",
    ColourBarline: "",
    ColourJudgementLine: "",
    ColourKeyWarning: "",
    ColourHold: "",
    ColourBreak: "",
    Colour: {},       // UI: 1..K, export: 0..K-1
    ColourLight: {},  // UI: 1..K, export: 0..K-1

    // patterns
    KeyImage: "",
    KeyImageD: "",
    NoteImage: "",
    NoteImageH: "",
    NoteImageL: "",
    NoteImageT: "",
    WarningArrow: "",

    // hits
    Hit0: "",
    Hit50: "",
    Hit100: "",
    Hit200: "",
    Hit300: "",
    Hit300g: "",

    // auto flag for columnstart
    AutoColumnStart: true,
  };
}

const state = {
  activeTab: "general",

  // export toggles
  exportStd: true,
  exportCatch: true,
  exportMania: true,

  // style toggles
  pretty: true,        // "h style"
  commentEmpty: false,

  version: "latest",

  general: {
    Name: "",
    Author: "",
    AnimationFramerate: "",
    AllowSliderBallTint: true,
    ComboBurstRandom: "",
    CursorCentre: true,
    CursorExpand: false,
    CursorRotate: false,
    CursorTrailRotate: false,
    CustomComboBurstSounds: "",
    HitCircleOverlayAboveNumber: false,
    LayeredHitSounds: true,
    SliderBallFlip: false,
    SpinnerFadePlayfield: true,
    SpinnerFrequencyModulate: "",
    SpinnerNoBlink: false,
  },

  colours: {
    Combo1: "",
    Combo2: "",
    Combo3: "",
    Combo4: "",
    Combo5: "",
    Combo6: "",
    Combo7: "",
    Combo8: "",
    InputOverlayText: "",
    MenuGlow: "",
    SliderBall: "",
    SliderBorder: "",
    SliderTrackOverride: "",
    SongSelectActiveText: "",
    SongSelectInactiveText: "",
    SpinnerBackground: "",
    StarBreakAdditive: "",
  },

  fonts: {
    HitCirclePrefix: "",
    HitCircleOverlap: "",
    ScorePrefix: "",
    ScoreOverlap: "",
    ComboPrefix: "",
    ComboOverlap: "",
  },

  catch: {
    HyperDash: "",
    HyperDashFruit: "",
    HyperDashAfterImage: "",
  },

  maniaShared: {
    enabled: Object.fromEntries(ALL_MANIA_KEYS.map(k => [k, k===4])),
    open: Object.fromEntries(ALL_MANIA_KEYS.map(k => [k, k===4])),
  },

  mania: Object.fromEntries(ALL_MANIA_KEYS.map(k => [k, defaultManiaMode(k)])),
};

/* ---------- state path helpers ---------- */
function pathToId(path){
  return "p_" + path.replaceAll(".", "__").replaceAll("[","_").replaceAll("]","_");
}
function getByPath(obj, path){
  const parts = path.split(".");
  let cur = obj;
  for(const p of parts){
    if(cur == null) return undefined;
    cur = cur[p];
  }
  return cur;
}
function setByPath(obj, path, value){
  const parts = path.split(".");
  let cur = obj;
  for(let i=0;i<parts.length-1;i++){
    const p = parts[i];
    if(!(p in cur)) cur[p] = {};
    cur = cur[p];
  }
  cur[parts[parts.length-1]] = value;
}

/* ---------- UI builders ---------- */
function uiRowText(label, path, placeholder=""){
  const id = pathToId(path);
  return `
    <div class="row">
      <label for="${id}">${label}</label>
      <input type="text" id="${id}" data-path="${path}" placeholder="${escapeHtml(placeholder)}">
    </div>
  `;
}
function uiRowNum(label, path, placeholder=""){
  const id = pathToId(path);
  return `
    <div class="row">
      <label for="${id}">${label}</label>
      <input type="number" id="${id}" data-path="${path}" placeholder="${escapeHtml(placeholder)}">
    </div>
  `;
}
function uiRowBool(label, path){
  const id = pathToId(path);
  return `
    <div class="row">
      <label>${label}</label>
      <div class="inline">
        <label class="switch">
          <input type="checkbox" id="${id}" data-path="${path}">
          <span class="sw"></span>
        </label>
      </div>
    </div>
  `;
}
function uiRowColor(label, path){
  const id = pathToId(path);
  const pickId = id + "_pick";
  return `
    <div class="row">
      <label>${label}</label>
      <div class="inline">
        <input type="color" id="${pickId}" data-pick-for="${id}">
        <input type="text" id="${id}" data-path="${path}" placeholder="255,255,255">
      </div>
    </div>
  `;
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* ---------- Tabs ---------- */
const TABS = [
  { key:"general", title:"General", render: renderGeneral },
  { key:"colours", title:"Colours", render: renderColours },
  { key:"fonts", title:"Fonts", render: renderFonts },
  { key:"catch", title:"Catch", render: renderCatch },
  { key:"mania", title:"Mania", render: renderMania },
  { key:"preview", title:"Preview", render: renderPreviewOnly },
];

function setActiveTab(k){
  state.activeTab = k;
  renderDockActive();
  renderActiveTab();
  saveSoon();
}

function renderDockActive(){
  document.querySelectorAll(".icoBtn[data-tab]").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab === state.activeTab);
  });
}

function updateTopSub(){
  const t = TABS.find(x=>x.key===state.activeTab)?.title ?? "‚Äî";
  $("topSub").textContent = t;
  $("panelTitle").textContent = t;
}

/* ---------- Panels ---------- */
function renderActiveTab(){
  updateTopSub();
  const tab = TABS.find(t => t.key === state.activeTab) || TABS[0];
  $("panel").innerHTML = tab.render();
  hydrateInputsFromState($("panel"));
  wirePanelListeners($("panel"));
}

function renderGeneral(){
  const disabled = !state.exportStd;
  return `
    ${disabled ? `<div class="disabledHint">Standard export desligado</div>` : ``}

    <div class="block open">
      <button class="blockHead" type="button"><span>[General] meta</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowText("Name", "general.Name")}
        ${uiRowText("Author", "general.Author")}
        <div class="row">
          <label>Version</label>
          <input type="text" value="${escapeHtml(state.version)}" readonly>
        </div>
      </div>
    </div>

    <div class="block open">
      <button class="blockHead" type="button"><span>[General] cursor</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowBool("CursorCentre", "general.CursorCentre")}
        ${uiRowBool("CursorExpand", "general.CursorExpand")}
        ${uiRowBool("CursorRotate", "general.CursorRotate")}
        ${uiRowBool("CursorTrailRotate", "general.CursorTrailRotate")}
      </div>
    </div>

    <div class="block">
      <button class="blockHead" type="button"><span>[General] gameplay</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowNum("AnimationFramerate", "general.AnimationFramerate")}
        ${uiRowBool("AllowSliderBallTint", "general.AllowSliderBallTint")}
        ${uiRowBool("SliderBallFlip", "general.SliderBallFlip")}
        ${uiRowBool("HitCircleOverlayAboveNumber", "general.HitCircleOverlayAboveNumber")}
        ${uiRowBool("LayeredHitSounds", "general.LayeredHitSounds")}
        ${uiRowBool("SpinnerFadePlayfield", "general.SpinnerFadePlayfield")}
        ${uiRowBool("SpinnerNoBlink", "general.SpinnerNoBlink")}
        ${uiRowText("SpinnerFrequencyModulate", "general.SpinnerFrequencyModulate")}
      </div>
    </div>

    <div class="block">
      <button class="blockHead" type="button"><span>[General] misc</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowText("ComboBurstRandom", "general.ComboBurstRandom")}
        ${uiRowText("CustomComboBurstSounds", "general.CustomComboBurstSounds")}
      </div>
    </div>
  `;
}

function renderColours(){
  const disabled = !state.exportStd;
  return `
    ${disabled ? `<div class="disabledHint">Standard export desligado</div>` : ``}

    <div class="block open">
      <button class="blockHead" type="button"><span>[Colours] ui</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowColor("MenuGlow", "colours.MenuGlow")}
        ${uiRowColor("InputOverlayText", "colours.InputOverlayText")}
        ${uiRowColor("SongSelectActiveText", "colours.SongSelectActiveText")}
        ${uiRowColor("SongSelectInactiveText", "colours.SongSelectInactiveText")}
      </div>
    </div>

    <div class="block open">
      <button class="blockHead" type="button"><span>[Colours] combo</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        <div class="grid2">
          ${uiRowColor("Combo1", "colours.Combo1")}
          ${uiRowColor("Combo2", "colours.Combo2")}
          ${uiRowColor("Combo3", "colours.Combo3")}
          ${uiRowColor("Combo4", "colours.Combo4")}
          ${uiRowColor("Combo5", "colours.Combo5")}
          ${uiRowColor("Combo6", "colours.Combo6")}
          ${uiRowColor("Combo7", "colours.Combo7")}
          ${uiRowColor("Combo8", "colours.Combo8")}
        </div>
      </div>
    </div>

    <div class="block">
      <button class="blockHead" type="button"><span>[Colours] slider/spinner</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowColor("SliderBall", "colours.SliderBall")}
        ${uiRowColor("SliderBorder", "colours.SliderBorder")}
        ${uiRowColor("SliderTrackOverride", "colours.SliderTrackOverride")}
        ${uiRowColor("SpinnerBackground", "colours.SpinnerBackground")}
        ${uiRowColor("StarBreakAdditive", "colours.StarBreakAdditive")}
      </div>
    </div>
  `;
}

function renderFonts(){
  const disabled = !state.exportStd;
  return `
    ${disabled ? `<div class="disabledHint">Standard export desligado</div>` : ``}

    <div class="block open">
      <button class="blockHead" type="button"><span>[Fonts] hitcircle</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowText("HitCirclePrefix", "fonts.HitCirclePrefix")}
        ${uiRowNum("HitCircleOverlap", "fonts.HitCircleOverlap", "0")}
      </div>
    </div>

    <div class="block open">
      <button class="blockHead" type="button"><span>[Fonts] score</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowText("ScorePrefix", "fonts.ScorePrefix")}
        ${uiRowNum("ScoreOverlap", "fonts.ScoreOverlap", "0")}
      </div>
    </div>

    <div class="block open">
      <button class="blockHead" type="button"><span>[Fonts] combo</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowText("ComboPrefix", "fonts.ComboPrefix")}
        ${uiRowNum("ComboOverlap", "fonts.ComboOverlap", "0")}
      </div>
    </div>
  `;
}

function renderCatch(){
  const disabled = !state.exportCatch;
  return `
    ${disabled ? `<div class="disabledHint">Catch export desligado</div>` : ``}

    <div class="block open">
      <button class="blockHead" type="button"><span>[CatchTheBeat]</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        ${uiRowText("HyperDash", "catch.HyperDash")}
        ${uiRowText("HyperDashFruit", "catch.HyperDashFruit")}
        ${uiRowText("HyperDashAfterImage", "catch.HyperDashAfterImage")}
      </div>
    </div>
  `;
}

function renderMania(){
  const disabled = !state.exportMania;

  const pills = ALL_MANIA_KEYS.map(k=>{
    const on = !!state.maniaShared.enabled[k];
    return `
      <span class="kmPill ${on?"on":""}">
        <span>${k}K</span>
        <label class="switch">
          <input type="checkbox" class="kmToggle" data-k="${k}" ${on?"checked":""}>
          <span class="sw"></span>
        </label>
      </span>
    `;
  }).join("");

  const blocks = ALL_MANIA_KEYS
    .filter(k => state.maniaShared.enabled[k])
    .map(k => renderManiaBlock(k))
    .join("");

  return `
    ${disabled ? `<div class="disabledHint">Mania export desligado</div>` : ``}

    <div class="block open">
      <button class="blockHead" type="button"><span>keymodes</span><span class="caret">‚ñ∏</span></button>
      <div class="blockBody">
        <div class="kmRow">${pills}</div>
      </div>
    </div>

    <div id="maniaBlocks">
      ${blocks || `<div class="disabledHint">nenhum modo ativo</div>`}
    </div>
  `;
}

function renderManiaBlock(keys){
  const m = state.mania[keys] || defaultManiaMode(keys);
  const open = !!state.maniaShared.open[keys];

  // UI: Colour1..ColourK, export: Colour0..Colour(K-1)
  const colourCols = Array.from({length: keys}, (_,i)=>{
    const uiIndex = i + 1;
    const path = `mania.${keys}.Colour.${uiIndex}`;
    return `
      <div class="row">
        <label>Colour${uiIndex}</label>
        <div class="inline">
          <input type="color" id="${pathToId(path)}_pick" data-pick-for="${pathToId(path)}">
          <input type="text" id="${pathToId(path)}" data-path="${path}" placeholder="255,255,255">
        </div>
      </div>
    `;
  }).join("");

  const colourLights = Array.from({length: keys}, (_,i)=>{
    const uiIndex = i + 1;
    const path = `mania.${keys}.ColourLight.${uiIndex}`;
    return `
      <div class="row">
        <label>ColourLight${uiIndex}</label>
        <div class="inline">
          <input type="color" id="${pathToId(path)}_pick" data-pick-for="${pathToId(path)}">
          <input type="text" id="${pathToId(path)}" data-path="${path}" placeholder="">
        </div>
      </div>
    `;
  }).join("");

  return `
    <div class="block ${open?"open":""}" data-keys="${keys}">
      <button class="blockHead" type="button" data-fold="${keys}">
        <span>${keys}K</span>
        <span class="caret">‚ñ∏</span>
      </button>

      <div class="blockBody">
        <div class="block open">
          <button class="blockHead" type="button"><span>layout</span><span class="caret">‚ñ∏</span></button>
          <div class="blockBody">
            ${uiRowBool("Auto ColumnStart", `mania.${keys}.AutoColumnStart`)}
            ${uiRowNum("ColumnStart", `mania.${keys}.ColumnStart`)}
            ${uiRowNum("ColumnRight", `mania.${keys}.ColumnRight`)}

            ${uiRowText("ColumnWidth", `mania.${keys}.ColumnWidth`, "70 ou 70,70,70")}
            ${uiRowText("ColumnSpacing", `mania.${keys}.ColumnSpacing`, "0 ou 0,0,0")}
            ${uiRowText("ColumnLineWidth", `mania.${keys}.ColumnLineWidth`, "")}
          </div>
        </div>

        <div class="block open">
          <button class="blockHead" type="button"><span>positions</span><span class="caret">‚ñ∏</span></button>
          <div class="blockBody">
            ${uiRowNum("HitPosition", `mania.${keys}.HitPosition`)}
            ${uiRowNum("LightPosition", `mania.${keys}.LightPosition`)}
            ${uiRowNum("ScorePosition", `mania.${keys}.ScorePosition`)}
            ${uiRowNum("ComboPosition", `mania.${keys}.ComboPosition`)}
          </div>
        </div>

        <div class="block">
          <button class="blockHead" type="button"><span>toggles</span><span class="caret">‚ñ∏</span></button>
          <div class="blockBody">
            ${uiRowBool("JudgementLine", `mania.${keys}.JudgementLine`)}
            ${uiRowBool("KeysUnderNotes", `mania.${keys}.KeysUnderNotes`)}
            ${uiRowBool("UpsideDown", `mania.${keys}.UpsideDown`)}

            ${uiRowText("KeyFlipWhenUpsideDown", `mania.${keys}.KeyFlipWhenUpsideDown`)}
            ${uiRowText("NoteFlipWhenUpsideDown", `mania.${keys}.NoteFlipWhenUpsideDown`)}
            ${uiRowText("NoteBodyStyle", `mania.${keys}.NoteBodyStyle`)}
          </div>
        </div>

        <div class="block">
          <button class="blockHead" type="button"><span>stage/lighting</span><span class="caret">‚ñ∏</span></button>
          <div class="blockBody">
            <div class="grid2">
              <div>
                ${uiRowText("StageLeft", `mania.${keys}.StageLeft`)}
                ${uiRowText("StageRight", `mania.${keys}.StageRight`)}
                ${uiRowText("StageBottom", `mania.${keys}.StageBottom`)}
                ${uiRowText("StageHint", `mania.${keys}.StageHint`)}
                ${uiRowText("StageLight", `mania.${keys}.StageLight`)}
              </div>
              <div>
                ${uiRowNum("LightingNWidth", `mania.${keys}.LightingNWidth`)}
                ${uiRowNum("LightingLWidth", `mania.${keys}.LightingLWidth`)}
                ${uiRowText("LightingN", `mania.${keys}.LightingN`)}
                ${uiRowText("LightingL", `mania.${keys}.LightingL`)}
              </div>
            </div>

            ${uiRowNum("BarlineHeight", `mania.${keys}.BarlineHeight`)}
            ${uiRowNum("WidthForNoteHeightScale", `mania.${keys}.WidthForNoteHeightScale`)}
            ${uiRowNum("LightFramePerSecond", `mania.${keys}.LightFramePerSecond`)}
            ${uiRowText("SpecialStyle", `mania.${keys}.SpecialStyle`)}
            ${uiRowText("ComboBurstStyle", `mania.${keys}.ComboBurstStyle`)}
            ${uiRowText("SplitStages", `mania.${keys}.SplitStages`)}
            ${uiRowText("StageSeparation", `mania.${keys}.StageSeparation`)}
            ${uiRowText("SeparateScore", `mania.${keys}.SeparateScore`)}
          </div>
        </div>

        <div class="block open">
          <button class="blockHead" type="button"><span>colours</span><span class="caret">‚ñ∏</span></button>
          <div class="blockBody">
            <div class="grid2">
              <div>${colourCols}</div>
              <div>${colourLights}</div>
            </div>

            ${uiRowColor("ColourColumnLine", `mania.${keys}.ColourColumnLine`)}
            ${uiRowColor("ColourBarline", `mania.${keys}.ColourBarline`)}
            ${uiRowColor("ColourJudgementLine", `mania.${keys}.ColourJudgementLine`)}
            ${uiRowColor("ColourKeyWarning", `mania.${keys}.ColourKeyWarning`)}
            ${uiRowColor("ColourHold", `mania.${keys}.ColourHold`)}
            ${uiRowColor("ColourBreak", `mania.${keys}.ColourBreak`)}
          </div>
        </div>

        <div class="block">
          <button class="blockHead" type="button"><span>sprites/patterns</span><span class="caret">‚ñ∏</span></button>
          <div class="blockBody">
            ${uiRowText("KeyImage pattern", `mania.${keys}.KeyImage`, "key{n}")}
            ${uiRowText("KeyImageD pattern", `mania.${keys}.KeyImageD`, "key{n}D")}
            ${uiRowText("NoteImage pattern", `mania.${keys}.NoteImage`, "note{n}")}
            ${uiRowText("NoteImageH pattern", `mania.${keys}.NoteImageH`, "note{n}H")}
            ${uiRowText("NoteImageL pattern", `mania.${keys}.NoteImageL`, "note{n}L")}
            ${uiRowText("NoteImageT pattern", `mania.${keys}.NoteImageT`, "note{n}T")}
            ${uiRowText("WarningArrow", `mania.${keys}.WarningArrow`)}
          </div>
        </div>

        <div class="block">
          <button class="blockHead" type="button"><span>hits</span><span class="caret">‚ñ∏</span></button>
          <div class="blockBody">
            <div class="grid2">
              ${uiRowText("Hit0", `mania.${keys}.Hit0`)}
              ${uiRowText("Hit50", `mania.${keys}.Hit50`)}
              ${uiRowText("Hit100", `mania.${keys}.Hit100`)}
              ${uiRowText("Hit200", `mania.${keys}.Hit200`)}
              ${uiRowText("Hit300", `mania.${keys}.Hit300`)}
              ${uiRowText("Hit300g", `mania.${keys}.Hit300g`)}
            </div>
          </div>
        </div>

      </div>
    </div>
  `;
}

function renderPreviewOnly(){
  // painel s√≥ com preview (pra quando quiser ver ‚Äúlimpo‚Äù)
  return `
    <div class="disabledHint">use o painel da direita</div>
  `;
}

/* ---------- Accordions + hydration ---------- */
function wireAccordions(root){
  // generic blocks
  root.querySelectorAll(".blockHead").forEach(head=>{
    const parent = head.closest(".block");
    if(!parent) return;

    // mania fold
    if(head.dataset.fold){
      head.addEventListener("click", ()=>{
        const k = Number(head.dataset.fold);
        const block = root.querySelector(`.block[data-keys="${k}"]`);
        if(!block) return;
        const nowOpen = !block.classList.contains("open");
        block.classList.toggle("open", nowOpen);
        state.maniaShared.open[k] = nowOpen;
        saveSoon();
      });
      return;
    }

    // open/close
    head.addEventListener("click", ()=>{
      const nowOpen = !parent.classList.contains("open");
      parent.classList.toggle("open", nowOpen);
    });
  });
}

function bindColorPickers(root){
  root.querySelectorAll("[data-pick-for]").forEach(pick=>{
    const txtId = pick.getAttribute("data-pick-for");
    const txt = document.getElementById(txtId);
    if(!txt) return;

    // initial sync
    const hx = rgbToHex(txt.value);
    if(hx) pick.value = hx;

    pick.addEventListener("input", ()=>{
      txt.value = hexToRgb(pick.value);
      // dispara estado/export
      txt.dispatchEvent(new Event("input", {bubbles:true}));
    });

    txt.addEventListener("input", ()=>{
      const hx2 = rgbToHex(txt.value);
      if(hx2) pick.value = hx2;
    });
  });
}

function hydrateInputsFromState(root){
  root.querySelectorAll("[data-path]").forEach(inp=>{
    const path = inp.getAttribute("data-path");
    const v = getByPath(state, path);

    if(inp.type === "checkbox"){
      inp.checked = !!v;
    }else{
      inp.value = (v ?? "");
    }
  });

  // ColumnStart disabled when AutoColumnStart on
  root.querySelectorAll('[data-path$=".AutoColumnStart"]').forEach(chk=>{
    const path = chk.getAttribute("data-path"); // mania.K.AutoColumnStart
    const mPath = path.replace(".AutoColumnStart", ".ColumnStart");
    const col = root.querySelector(`[data-path="${mPath}"]`);
    if(col){
      col.disabled = !!chk.checked;
      col.placeholder = chk.checked ? "auto" : "";
      if(chk.checked) col.value = "";
    }
  });

  bindColorPickers(root);
  wireAccordions(root);
}

/* ---------- listeners ---------- */
function wirePanelListeners(root){
  // all data-path inputs
  root.querySelectorAll("[data-path]").forEach(inp=>{
    const path = inp.getAttribute("data-path");
    const handler = ()=>{
      if(inp.type === "checkbox"){
        setByPath(state, path, !!inp.checked);
      }else{
        setByPath(state, path, inp.value);
      }

      // special: AutoColumnStart toggles disable ColumnStart + clears it
      if(path.endsWith(".AutoColumnStart")){
        const mPath = path.replace(".AutoColumnStart", ".ColumnStart");
        const col = root.querySelector(`[data-path="${mPath}"]`);
        if(col){
          col.disabled = !!inp.checked;
          col.placeholder = inp.checked ? "auto" : "";
          if(inp.checked){
            col.value = "";
            setByPath(state, mPath, "");
          }
        }
      }

      onAnyChange();
    };
    inp.addEventListener("input", handler);
    inp.addEventListener("change", handler);
  });

  // mania keymode toggles
  root.querySelectorAll(".kmToggle").forEach(t=>{
    t.addEventListener("change", ()=>{
      const k = Number(t.dataset.k);
      state.maniaShared.enabled[k] = !!t.checked;
      state.maniaShared.open[k] = !!t.checked;

      if(!ALL_MANIA_KEYS.some(x=>state.maniaShared.enabled[x])){
        state.maniaShared.enabled[4]=true;
        state.maniaShared.open[4]=true;
      }
      renderActiveTab();
      onAnyChange();
    });
  });
}

/* ---------- ini generation ---------- */
function genIni(){
  const out = [];

  // STANDARD: [General] [Colours] [Fonts]
  if(state.exportStd){
    out.push("[General]");
    pushKV(out, "Name", state.general.Name);
    pushKV(out, "Author", state.general.Author);
    out.push(fmtKV("Version", state.version));

    const g = state.general;
    pushKV(out, "AnimationFramerate", g.AnimationFramerate);
    pushKV(out, "AllowSliderBallTint", bool01(!!g.AllowSliderBallTint));
    pushKV(out, "ComboBurstRandom", g.ComboBurstRandom);
    pushKV(out, "CursorCentre", bool01(!!g.CursorCentre));
    pushKV(out, "CursorExpand", bool01(!!g.CursorExpand));
    pushKV(out, "CursorRotate", bool01(!!g.CursorRotate));
    pushKV(out, "CursorTrailRotate", bool01(!!g.CursorTrailRotate));
    pushKV(out, "CustomComboBurstSounds", g.CustomComboBurstSounds);
    pushKV(out, "HitCircleOverlayAboveNumber", bool01(!!g.HitCircleOverlayAboveNumber));
    pushKV(out, "LayeredHitSounds", bool01(!!g.LayeredHitSounds));
    pushKV(out, "SliderBallFlip", bool01(!!g.SliderBallFlip));
    pushKV(out, "SpinnerFadePlayfield", bool01(!!g.SpinnerFadePlayfield));
    pushKV(out, "SpinnerFrequencyModulate", g.SpinnerFrequencyModulate);
    pushKV(out, "SpinnerNoBlink", bool01(!!g.SpinnerNoBlink));

    out.push("");

    const c = state.colours;
    const colourKeys = [
      "Combo1","Combo2","Combo3","Combo4","Combo5","Combo6","Combo7","Combo8",
      "InputOverlayText","MenuGlow","SliderBall","SliderBorder","SliderTrackOverride",
      "SongSelectActiveText","SongSelectInactiveText","SpinnerBackground","StarBreakAdditive"
    ];
    const hasColours = colourKeys.some(k => !isBlank(c[k]));
    if(hasColours){
      out.push("[Colours]");
      for(const k of colourKeys) pushKV(out, k, c[k]);
      out.push("");
    }

    const f = state.fonts;
    const fontKeys = ["HitCirclePrefix","HitCircleOverlap","ScorePrefix","ScoreOverlap","ComboPrefix","ComboOverlap"];
    const hasFonts = fontKeys.some(k => !isBlank(f[k]));
    if(hasFonts){
      out.push("[Fonts]");
      for(const k of fontKeys) pushKV(out, k, f[k]);
      out.push("");
    }
  }

  // CATCH
  if(state.exportCatch){
    const ca = state.catch;
    const catchKeys = ["HyperDash","HyperDashFruit","HyperDashAfterImage"];
    const hasCatch = catchKeys.some(k => !isBlank(ca[k]));
    if(hasCatch){
      out.push("[CatchTheBeat]");
      for(const k of catchKeys) pushKV(out, k, ca[k]);
      out.push("");
    }
  }

  // MANIA
  if(state.exportMania){
    for(const keys of ALL_MANIA_KEYS){
      if(!state.maniaShared.enabled[keys]) continue;
      out.push("[Mania]");
      out.push(...genManiaBlock(keys));
      out.push("");
    }
  }

  while(out.length && out[out.length-1]==="") out.pop();
  return out.join("\n");
}

function pat(pattern, n){
  const p = String(pattern||"").trim();
  if(!p) return "";
  return p.replaceAll("{n}", String(n));
}

function genManiaBlock(keys){
  const m = state.mania[keys] || defaultManiaMode(keys);
  const lines = [];

  lines.push(fmtKV("Keys", keys));
  spacer(lines);

  function normalizeCsv(raw, count, fallback){
    const r = cleanLine(raw);
    if(!r) return fallback;
    if(r.includes(",")) return r;
    return Array.from({length: count}, ()=>r).join(",");
  }

  lines.push(fmtKV("ColumnWidth", normalizeCsv(m.ColumnWidth, keys, Array.from({length:keys}, ()=>"70").join(","))));
  lines.push(fmtKV("ColumnSpacing", normalizeCsv(m.ColumnSpacing, Math.max(0,keys-1), Array.from({length:Math.max(0,keys-1)}, ()=>"0").join(","))));

  // ColumnStart: auto se vazio ou AutoColumnStart = true -> n√£o exporta a linha
  if(!m.AutoColumnStart){
    pushKV(lines, "ColumnStart", m.ColumnStart);
  }

  pushKV(lines, "ColumnRight", m.ColumnRight);
  pushKV(lines, "ColumnLineWidth", normalizeCsv(m.ColumnLineWidth, keys+1, Array.from({length:keys+1}, ()=>"0").join(",")));
  spacer(lines);

  pushKV(lines, "HitPosition", m.HitPosition);
  pushKV(lines, "LightPosition", m.LightPosition);
  pushKV(lines, "ScorePosition", m.ScorePosition);
  pushKV(lines, "ComboPosition", m.ComboPosition);
  spacer(lines);

  lines.push(fmtKV("JudgementLine", bool01(!!m.JudgementLine)));
  lines.push(fmtKV("KeysUnderNotes", bool01(!!m.KeysUnderNotes)));
  lines.push(fmtKV("UpsideDown", bool01(!!m.UpsideDown)));
  spacer(lines);

  pushKV(lines, "KeyFlipWhenUpsideDown", m.KeyFlipWhenUpsideDown);
  pushKV(lines, "NoteFlipWhenUpsideDown", m.NoteFlipWhenUpsideDown);
  pushKV(lines, "NoteBodyStyle", m.NoteBodyStyle);
  spacer(lines);

  header(lines, "stage");
  pushKV(lines, "StageLeft", m.StageLeft);
  pushKV(lines, "StageRight", m.StageRight);
  pushKV(lines, "StageBottom", m.StageBottom);
  pushKV(lines, "StageHint", m.StageHint);
  pushKV(lines, "StageLight", m.StageLight);
  pushKV(lines, "LightingNWidth", m.LightingNWidth);
  pushKV(lines, "LightingLWidth", m.LightingLWidth);
  pushKV(lines, "LightingN", m.LightingN);
  pushKV(lines, "LightingL", m.LightingL);
  spacer(lines);

  pushKV(lines, "BarlineHeight", m.BarlineHeight);
  pushKV(lines, "WidthForNoteHeightScale", m.WidthForNoteHeightScale);
  pushKV(lines, "LightFramePerSecond", m.LightFramePerSecond);
  pushKV(lines, "SpecialStyle", m.SpecialStyle);
  pushKV(lines, "ComboBurstStyle", m.ComboBurstStyle);
  pushKV(lines, "SplitStages", m.SplitStages);
  pushKV(lines, "StageSeparation", m.StageSeparation);
  pushKV(lines, "SeparateScore", m.SeparateScore);
  spacer(lines);

  header(lines, "colours");

  // UI indexes 1..K, export uses 0..K-1 (compat)
  for(let ui=1; ui<=keys; ui++){
    const v = cleanLine(m.Colour?.[ui]);
    if(v) lines.push(fmtKV(`Colour${ui-1}`, v));
  }
  spacer(lines);

  for(let ui=1; ui<=keys; ui++){
    const v = cleanLine(m.ColourLight?.[ui]);
    if(v) lines.push(fmtKV(`ColourLight${ui-1}`, v));
  }

  pushKV(lines, "ColourColumnLine", m.ColourColumnLine);
  pushKV(lines, "ColourBarline", m.ColourBarline);
  pushKV(lines, "ColourJudgementLine", m.ColourJudgementLine);
  pushKV(lines, "ColourKeyWarning", m.ColourKeyWarning);
  pushKV(lines, "ColourHold", m.ColourHold);
  pushKV(lines, "ColourBreak", m.ColourBreak);
  spacer(lines);

  header(lines, "images");
  for(let idx=0; idx<keys; idx++){
    const n = idx+1;
    const a = pat(m.KeyImage, n); if(a) lines.push(fmtKV(`KeyImage${idx}`, a));
  }
  spacer(lines);
  for(let idx=0; idx<keys; idx++){
    const n = idx+1;
    const a = pat(m.KeyImageD, n); if(a) lines.push(fmtKV(`KeyImage${idx}D`, a));
  }
  spacer(lines);

  for(let idx=0; idx<keys; idx++){
    const n = idx+1;
    const a = pat(m.NoteImage, n); if(a) lines.push(fmtKV(`NoteImage${idx}`, a));
  }
  spacer(lines);
  for(let idx=0; idx<keys; idx++){
    const n = idx+1;
    const a = pat(m.NoteImageH, n); if(a) lines.push(fmtKV(`NoteImage${idx}H`, a));
  }
  spacer(lines);
  for(let idx=0; idx<keys; idx++){
    const n = idx+1;
    const a = pat(m.NoteImageL, n); if(a) lines.push(fmtKV(`NoteImage${idx}L`, a));
  }
  spacer(lines);
  for(let idx=0; idx<keys; idx++){
    const n = idx+1;
    const a = pat(m.NoteImageT, n); if(a) lines.push(fmtKV(`NoteImage${idx}T`, a));
  }
  spacer(lines);

  pushKV(lines, "WarningArrow", m.WarningArrow);
  spacer(lines);

  header(lines, "hits");
  pushKV(lines, "Hit0", m.Hit0);
  pushKV(lines, "Hit50", m.Hit50);
  pushKV(lines, "Hit100", m.Hit100);
  pushKV(lines, "Hit200", m.Hit200);
  pushKV(lines, "Hit300", m.Hit300);
  pushKV(lines, "Hit300g", m.Hit300g);

  while(lines.length && lines[lines.length-1]==="") lines.pop();
  return lines;
}

/* ---------- import (mais robusto) ---------- */
function parseIni(text){
  const lines = String(text||"").split("\n");

  const parsed = {
    General:{}, Colours:{}, Fonts:{}, CatchTheBeat:{},
    Mania: [] // {Keys, kv}
  };

  let section = "";
  let curMania = null;

  for(const raw of lines){
    const line0 = raw.replace(/\r/g,"");
    const line = line0.trim();

    if(!line) continue;
    if(line.startsWith("//") || line.startsWith(";")) continue;

    const sec = line.match(/^\[(.+?)\]\s*$/);
    if(sec){
      section = sec[1];
      if(section.toLowerCase() === "mania"){
        curMania = { Keys:null, kv:{} };
        parsed.Mania.push(curMania);
      }else{
        curMania = null;
      }
      continue;
    }

    // suporta "Key: value" e "Key : value" e "Key=value"
    let m = line.match(/^([A-Za-z0-9]+)\s*:\s*(.*)$/);
    if(!m) m = line.match(/^([A-Za-z0-9]+)\s*=\s*(.*)$/);
    if(!m) continue;

    const key = m[1];
    const val = (m[2] ?? "").trim();

    const secName = section.toLowerCase();
    if(secName === "general") parsed.General[key] = val;
    else if(secName === "colours") parsed.Colours[key] = val;
    else if(secName === "fonts") parsed.Fonts[key] = val;
    else if(secName === "catchthebeat") parsed.CatchTheBeat[key] = val;
    else if(secName === "mania" && curMania){
      curMania.kv[key] = val;
      if(key === "Keys"){
        const k = parseInt(val,10);
        curMania.Keys = Number.isFinite(k) ? k : null;
      }
    }
  }
  return parsed;
}

function applyParsed(parsed){
  // version
  if(parsed.General.Version) state.version = parsed.General.Version;

  // general
  for(const k in state.general){
    if(k in parsed.General){
      if(typeof state.general[k] === "boolean"){
        state.general[k] = parsed.General[k].trim() === "1";
      }else{
        state.general[k] = parsed.General[k];
      }
    }
  }

  // colours
  for(const k in state.colours){
    if(k in parsed.Colours) state.colours[k] = parsed.Colours[k];
  }

  // fonts
  for(const k in state.fonts){
    if(k in parsed.Fonts) state.fonts[k] = parsed.Fonts[k];
  }

  // catch
  for(const k in state.catch){
    if(k in parsed.CatchTheBeat) state.catch[k] = parsed.CatchTheBeat[k];
  }

  // mania
  for(const blk of parsed.Mania){
    const keys = blk.Keys;
    if(!keys || keys < 1 || keys > 18) continue;

    state.maniaShared.enabled[keys] = true;
    state.maniaShared.open[keys] = true;

    const m = state.mania[keys] || defaultManiaMode(keys);

    const direct = [
      "ColumnStart","ColumnRight","ColumnSpacing","ColumnWidth","ColumnLineWidth",
      "HitPosition","LightPosition","ScorePosition","ComboPosition",
      "JudgementLine","KeysUnderNotes","UpsideDown",
      "BarlineHeight","WidthForNoteHeightScale","LightingNWidth","LightingLWidth",
      "LightFramePerSecond","SpecialStyle","ComboBurstStyle","SplitStages","StageSeparation","SeparateScore",
      "KeyFlipWhenUpsideDown","NoteFlipWhenUpsideDown","NoteBodyStyle",
      "StageLeft","StageRight","StageBottom","StageHint","StageLight","LightingN","LightingL",
      "ColourColumnLine","ColourBarline","ColourJudgementLine","ColourKeyWarning","ColourHold","ColourBreak",
      "WarningArrow",
      "Hit0","Hit50","Hit100","Hit200","Hit300","Hit300g"
    ];

    for(const k of direct){
      if(k in blk.kv){
        if(typeof m[k] === "boolean") m[k] = blk.kv[k].trim() === "1";
        else m[k] = blk.kv[k];
      }
    }

    // ColumnStart auto flag
    if(isBlank(m.ColumnStart)){
      m.AutoColumnStart = true;
    }else{
      m.AutoColumnStart = false;
    }

    // import colours: file is Colour0.. -> UI becomes Colour1..
    for(let i=0;i<keys;i++){
      const ck = `Colour${i}`;
      const lk = `ColourLight${i}`;
      if(ck in blk.kv) m.Colour[i+1] = blk.kv[ck];
      if(lk in blk.kv) m.ColourLight[i+1] = blk.kv[lk];
    }

    // patterns: tenta montar pattern se achar idx0/1 (heur√≠stica simples)
    function guessPattern(prefix){
      const a = blk.kv[`${prefix}0`];
      const b = blk.kv[`${prefix}1`];
      if(!a || !b) return "";
      const a2 = a.replaceAll("1","{n}");
      const b2 = b.replaceAll("2","{n}");
      if(a2 === b2) return a2;
      return "";
    }
    const gKey = guessPattern("KeyImage");
    const gKeyD = guessPattern("KeyImageD");
    const gNote = guessPattern("NoteImage");
    const gNoteH = guessPattern("NoteImageH");
    const gNoteL = guessPattern("NoteImageL");
    const gNoteT = guessPattern("NoteImageT");
    if(gKey) m.KeyImage = gKey;
    if(gKeyD) m.KeyImageD = gKeyD;
    if(gNote) m.NoteImage = gNote;
    if(gNoteH) m.NoteImageH = gNoteH;
    if(gNoteL) m.NoteImageL = gNoteL;
    if(gNoteT) m.NoteImageT = gNoteT;

    state.mania[keys] = m;
  }

  saveSoon(true);
  renderActiveTab();
}

/* ---------- save/load ---------- */
function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    $("savePulse").textContent = "Saved";
    setTimeout(()=>{ $("savePulse").textContent="‚Äî"; }, 700);
  }catch(e){
    $("savePulse").textContent = "ERR";
  }
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    if(!s) return;

    state.activeTab = s.activeTab ?? state.activeTab;

    state.exportStd = (s.exportStd ?? true) ? true : false;
    state.exportCatch = (s.exportCatch ?? true) ? true : false;
    state.exportMania = (s.exportMania ?? true) ? true : false;

    state.pretty = (s.pretty ?? true) ? true : false;
    state.commentEmpty = (s.commentEmpty ?? false) ? true : false;
    state.version = s.version ?? "latest";

    Object.assign(state.general, s.general || {});
    Object.assign(state.colours, s.colours || {});
    Object.assign(state.fonts, s.fonts || {});
    Object.assign(state.catch, s.catch || {});

    if(s.maniaShared){
      for(const k of ALL_MANIA_KEYS){
        state.maniaShared.enabled[k] = !!s.maniaShared.enabled?.[k];
        state.maniaShared.open[k] = !!s.maniaShared.open?.[k];
      }
      if(!ALL_MANIA_KEYS.some(k=>state.maniaShared.enabled[k])){
        state.maniaShared.enabled[4]=true;
        state.maniaShared.open[4]=true;
      }
    }

    if(s.mania){
      for(const k of ALL_MANIA_KEYS){
        if(s.mania[k]) state.mania[k] = { ...defaultManiaMode(k), ...s.mania[k] };
      }
    }
  }catch(e){}
}

const saveSoon = debounce((force=false)=>{
  saveState();
  if(force) updatePreview();
}, 350);

const previewSoon = debounce(()=> updatePreview(), 80);

function onAnyChange(){
  previewSoon();
  saveSoon();
  updateModeBadge();
}

/* ---------- actions ---------- */
function updatePreview(){
  $("preview").value = genIni();
}

function downloadIni(){
  const text = $("preview").value || genIni();
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "skin.ini";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function copyIni(){
  try{
    await navigator.clipboard.writeText($("preview").value || genIni());
    $("savePulse").textContent = "Copied";
    setTimeout(()=>{ $("savePulse").textContent="‚Äî"; }, 800);
  }catch(e){
    $("savePulse").textContent = "NoCopy";
    setTimeout(()=>{ $("savePulse").textContent="‚Äî"; }, 800);
  }
}

function wipeAll(){
  if(!confirm("Reset total + apagar autosave?")) return;
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  location.reload();
}

function updateModeBadge(){
  const parts = [];
  if(state.exportStd) parts.push("STD");
  if(state.exportCatch) parts.push("CATCH");
  if(state.exportMania) parts.push("MANIA");
  $("modeBadge").textContent = "export: " + (parts.join("+") || "NONE");
}

/* ---------- dock toggles ---------- */
function syncDockToggles(){
  // export toggles icons
  $("togStd").classList.toggle("active", state.exportStd);
  $("togCatch").classList.toggle("active", state.exportCatch);
  $("togMania").classList.toggle("active", state.exportMania);

  $("togPretty").classList.toggle("active", state.pretty);
  $("togCommentEmpty").classList.toggle("active", state.commentEmpty);
}

/* ---------- wire top-level ---------- */
document.querySelectorAll(".icoBtn[data-tab]").forEach(b=>{
  b.addEventListener("click", ()=> setActiveTab(b.dataset.tab));
});

$("downloadIni").addEventListener("click", downloadIni);
$("copyIni").addEventListener("click", copyIni);
$("wipeAll").addEventListener("click", wipeAll);
$("refresh").addEventListener("click", updatePreview);
$("selectAll").addEventListener("click", ()=>{
  $("preview").focus();
  $("preview").select();
});

$("togStd").addEventListener("click", ()=>{
  state.exportStd = !state.exportStd;
  syncDockToggles();
  onAnyChange();
  renderActiveTab();
});
$("togCatch").addEventListener("click", ()=>{
  state.exportCatch = !state.exportCatch;
  syncDockToggles();
  onAnyChange();
  renderActiveTab();
});
$("togMania").addEventListener("click", ()=>{
  state.exportMania = !state.exportMania;
  syncDockToggles();
  onAnyChange();
  renderActiveTab();
});

$("togPretty").addEventListener("click", ()=>{
  state.pretty = !state.pretty;
  syncDockToggles();
  onAnyChange();
});
$("togCommentEmpty").addEventListener("click", ()=>{
  state.commentEmpty = !state.commentEmpty;
  syncDockToggles();
  onAnyChange();
});

$("verBtn").addEventListener("click", ()=>{
  $("versionPick").value = state.version;
  $("verDlg").showModal();
});
$("versionPick").addEventListener("change", ()=>{
  state.version = $("versionPick").value;
  onAnyChange();
  renderActiveTab();
});

$("importOpen").addEventListener("click", ()=>{
  $("importArea").value = $("preview").value || "";
  $("importDlg").showModal();
});
$("importApply").addEventListener("click", ()=>{
  const parsed = parseIni($("importArea").value || "");
  applyParsed(parsed);
  $("importDlg").close();
});

/* ---------- init ---------- */
loadState();
syncDockToggles();
renderDockActive();
updateModeBadge();
renderActiveTab();
updatePreview();
</script>
</body>
</html>
