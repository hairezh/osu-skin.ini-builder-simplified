<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>A-Editor — skin.ini builder</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e8e8e8; --muted:#7a7a7a;
    --border:rgba(255,255,255,.08); --panel:rgba(255,255,255,.03);
    --fs:14px; --lh:1.6; --r:6px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:var(--fs)/var(--lh) ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    height:100vh;
  }
  .app{height:100vh; display:flex; flex-direction:column;}
  .topbar{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15)), var(--panel);
    gap:10px; flex-wrap:wrap;
  }
  .controls{display:flex; gap:6px; align-items:center; flex-wrap:wrap;}
  .btn{
    cursor:pointer; padding:6px 10px; border-radius:var(--r);
    border:1px solid var(--border); background:rgba(0,0,0,.25);
    color:var(--muted); font-weight:600;
  }
  .btn:hover{color:var(--fg); border-color:rgba(255,255,255,.18);}
  .btn.primary{color:var(--fg); background:rgba(255,255,255,.06);}
  .btn.danger:hover{border-color:rgba(255,120,120,.35); color:rgba(255,210,210,.95);}
  .pill{
    padding:6px 10px; border:1px solid var(--border); border-radius:var(--r);
    background:rgba(0,0,0,.18); color:rgba(232,232,232,.38); font-size:12px;
  }
  .main{flex:1; min-height:0; display:grid; grid-template-columns: 1.15fr 0.85fr; gap:10px; padding:10px;}
  .panel{
    border:1px solid var(--border); border-radius:var(--r);
    background:rgba(255,255,255,.02);
    min-height:0; overflow:hidden;
  }
  .panelHead{
    padding:8px 10px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .tabs{display:flex; gap:6px; flex-wrap:wrap;}
  .tab{
    cursor:pointer; padding:6px 10px; border-radius:var(--r);
    border:1px solid var(--border); background:rgba(0,0,0,.18);
    color:var(--muted); font-weight:600; user-select:none;
  }
  .tab.active{color:var(--fg); border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.05);}
  .panelBody{padding:10px; overflow:auto; max-height:100%;}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
  .row{display:grid; grid-template-columns: 170px 1fr; gap:10px; align-items:center; margin-bottom:8px;}
  .row label{color:rgba(232,232,232,.70); font-size:12px;}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;
    border:1px solid var(--border); border-radius:var(--r);
    background:rgba(0,0,0,.22); color:var(--fg);
    padding:7px 9px; outline:none;
    font:inherit;
  }
  textarea{min-height:260px; resize:vertical;}
  input[type="checkbox"]{transform:translateY(1px);}
  .hint{color:rgba(232,232,232,.38); font-size:12px; margin:8px 0 0;}
  .sep{height:1px; background:var(--border); margin:12px 0;}
  .mini{font-size:12px; color:rgba(232,232,232,.45);}
  .inline{display:flex; gap:6px; align-items:center; flex-wrap:wrap;}
  .colorRow{display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; margin-bottom:8px;}
  .colorRow input[type="color"]{width:44px; height:34px; border:1px solid var(--border); border-radius:var(--r); background:transparent; padding:0;}
  .kbd{border:1px solid var(--border); border-bottom-color:rgba(255,255,255,.14); background:rgba(0,0,0,.22); border-radius:6px; padding:1px 6px;}
  @media (max-width: 980px){
    .main{grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="controls">
      <button class="btn primary" id="downloadIni">Download skin.ini</button>
      <button class="btn" id="copyIni">Copy</button>
      <button class="btn" id="resetAll">Reset</button>
      <span class="pill" title="Everything stays in your browser (localStorage).">Local autosave • no uploads</span>
    </div>
    <div class="controls">
      <span class="pill" id="statChars">Chars: 0</span>
      <span class="pill" id="statLines">Lines: 0</span>
    </div>
  </div>

  <div class="main">
    <!-- LEFT: Builder -->
    <div class="panel">
      <div class="panelHead">
        <div class="tabs">
          <div class="tab active" data-tab="general">General</div>
          <div class="tab" data-tab="colours">Colours</div>
          <div class="tab" data-tab="fonts">Fonts</div>
          <div class="tab" data-tab="mania">Mania (simple)</div>
          <div class="tab" data-tab="advanced">Advanced</div>
        </div>
        <div class="mini">Build from zero → export.</div>
      </div>

      <div class="panelBody" id="tab-general">
        <div class="row">
          <label>Skin name</label>
          <input type="text" id="gName" placeholder="My Skin" />
        </div>
        <div class="row">
          <label>Author</label>
          <input type="text" id="gAuthor" placeholder="Your name" />
        </div>
        <div class="row">
          <label>Version</label>
          <select id="gVersion">
            <option value="">(leave empty)</option>
            <option>1.0</option>
            <option>2.0</option>
            <option>2.2</option>
            <option>2.5</option>
          </select>
        </div>

        <div class="sep"></div>
        <div class="mini">Gameplay behavior (simple toggles → writes 0/1)</div>

        <div class="row">
          <label>CursorCentre</label>
          <div class="inline">
            <input type="checkbox" id="gCursorCentre" checked />
            <span class="mini">Center cursor</span>
          </div>
        </div>
        <div class="row">
          <label>CursorExpand</label>
          <div class="inline">
            <input type="checkbox" id="gCursorExpand" />
            <span class="mini">Expand on hit</span>
          </div>
        </div>
        <div class="row">
          <label>CursorRotate</label>
          <div class="inline">
            <input type="checkbox" id="gCursorRotate" />
            <span class="mini">Rotate cursor</span>
          </div>
        </div>
        <div class="row">
          <label>CursorTrailRotate</label>
          <div class="inline">
            <input type="checkbox" id="gCursorTrailRotate" />
            <span class="mini">Rotate trail</span>
          </div>
        </div>

        <p class="hint">
          Tip: this builder generates a clean, minimal <span class="kbd">skin.ini</span>. You can add more later.
        </p>
      </div>

      <div class="panelBody" id="tab-colours" style="display:none">
        <div class="mini">Combo colors (add as many as you want)</div>
        <div class="sep"></div>

        <div id="comboList"></div>

        <div class="inline">
          <button class="btn" id="addCombo">+ Add combo color</button>
          <button class="btn" id="presetCombos">Preset (nice)</button>
        </div>

        <div class="sep"></div>
        <div class="mini">Sliders (optional)</div>

        <div class="row">
          <label>SliderBorder</label>
          <div class="inline">
            <input type="color" id="cSliderBorderPick" />
            <input type="text" id="cSliderBorder" placeholder="255,255,255" />
          </div>
        </div>

        <div class="row">
          <label>SliderTrackOverride</label>
          <div class="inline">
            <input type="color" id="cSliderTrackPick" />
            <input type="text" id="cSliderTrack" placeholder="0,0,0 (optional)" />
          </div>
        </div>

        <p class="hint">You can leave slider fields empty if you don’t want to override them.</p>
      </div>

      <div class="panelBody" id="tab-fonts" style="display:none">
        <div class="mini">These define which image prefixes osu! uses for numbers.</div>
        <div class="sep"></div>

        <div class="grid">
          <div>
            <div class="row">
              <label>HitCirclePrefix</label>
              <input type="text" id="fHitPrefix" placeholder="default" />
            </div>
            <div class="row">
              <label>HitCircleOverlap</label>
              <input type="number" id="fHitOverlap" value="-2" />
            </div>
          </div>

          <div>
            <div class="row">
              <label>ScorePrefix</label>
              <input type="text" id="fScorePrefix" placeholder="score" />
            </div>
            <div class="row">
              <label>ScoreOverlap</label>
              <input type="number" id="fScoreOverlap" value="0" />
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="grid">
          <div>
            <div class="row">
              <label>ComboPrefix</label>
              <input type="text" id="fComboPrefix" placeholder="combo" />
            </div>
            <div class="row">
              <label>ComboOverlap</label>
              <input type="number" id="fComboOverlap" value="0" />
            </div>
          </div>

          <div>
            <div class="row">
              <label>ScoreNumbers</label>
              <select id="fScoreNumbers">
                <option value="">(leave empty)</option>
                <option value="0">0 (use default)</option>
                <option value="1">1 (use your skin)</option>
              </select>
            </div>
            <div class="row">
              <label>ComboNumbers</label>
              <select id="fComboNumbers">
                <option value="">(leave empty)</option>
                <option value="0">0 (use default)</option>
                <option value="1">1 (use your skin)</option>
              </select>
            </div>
          </div>
        </div>

        <p class="hint">If you don’t know these yet, it’s okay. Defaults still work.</p>
      </div>

      <div class="panelBody" id="tab-mania" style="display:none">
        <div class="mini">
          Simple mania builder: you set <b>one value</b>, we generate the CSV lists (like your ColumnWidth example).
        </div>
        <div class="sep"></div>

        <div class="row">
          <label>Keys</label>
          <select id="mKeys">
            <option>4</option><option>5</option><option>6</option><option selected>7</option><option>8</option><option>9</option>
          </select>
        </div>

        <div class="row">
          <label>Column width (per column)</label>
          <input type="number" id="mColWidth" value="70" />
        </div>

        <div class="row">
          <label>Between-column spacing</label>
          <input type="number" id="mColSpacing" value="0" />
        </div>

        <div class="row">
          <label>Column line width (per column)</label>
          <input type="number" id="mLineWidth" value="0" />
        </div>

        <div class="row">
          <label>Hit position (Y)</label>
          <input type="number" id="mHitPos" value="402" />
        </div>

        <div class="row">
          <label>Score position (Y)</label>
          <input type="number" id="mScorePos" value="260" />
        </div>

        <div class="row">
          <label>Upside-down flip (auto)</label>
          <div class="inline">
            <input type="checkbox" id="mFlip" />
            <span class="mini">KeyFlipWhenUpsideDown = 1</span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <label>Center column different?</label>
          <div class="inline">
            <input type="checkbox" id="mCenterDifferent" />
            <span class="mini">Only for odd keys (5/7/9)</span>
          </div>
        </div>
        <div class="row">
          <label>Center width</label>
          <input type="number" id="mCenterWidth" value="80" />
        </div>

        <p class="hint">
          Output will include a single <span class="kbd">[Mania]</span> block with <span class="kbd">Keys: N</span>.
        </p>
      </div>

      <div class="panelBody" id="tab-advanced" style="display:none">
        <div class="mini">Optional: extra lines you want appended exactly as written.</div>
        <div class="sep"></div>

        <div class="row" style="grid-template-columns: 1fr;">
          <label>Extra ini lines (advanced)</label>
          <textarea id="aExtra" placeholder="[Section]
Key: Value
..."></textarea>
        </div>

        <div class="sep"></div>
        <div class="mini">Import (basic): paste a skin.ini and we try to load common fields.</div>
        <div class="row" style="grid-template-columns: 1fr;">
          <textarea id="aImport" placeholder="Paste your existing skin.ini here to import…"></textarea>
        </div>
        <div class="inline">
          <button class="btn" id="doImport">Import now</button>
          <span class="mini">(Basic import: General/Colours/Fonts/Mania simple.)</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="panel">
      <div class="panelHead">
        <div class="mini">Generated skin.ini</div>
        <div class="inline">
          <span class="mini" id="autosaveState"></span>
        </div>
      </div>
      <div class="panelBody">
        <textarea id="preview" readonly></textarea>
        <p class="hint">
          This is exactly what will be downloaded as <span class="kbd">skin.ini</span>.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
/* -----------------------------
  Helpers
------------------------------*/
const $ = (id)=>document.getElementById(id);
const STORAGE_KEY = "aeditor_skinini_builder_v1";

const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
function bool01(b){ return b ? "1" : "0"; }

function csvRepeat(value, count){
  return Array.from({length: count}, ()=>String(value)).join(",");
}
function csvBetween(value, keys){
  return csvRepeat(value, Math.max(0, keys-1));
}
function buildColumnWidth(keys, width, centerDifferent, centerWidth){
  const arr = Array.from({length: keys}, ()=>Number(width));
  if(centerDifferent && keys % 2 === 1){
    arr[Math.floor(keys/2)] = Number(centerWidth);
  }
  return arr.join(",");
}

function rgbToHex(rgb){
  // "r,g,b" -> "#rrggbb" ; returns null if invalid
  const m = String(rgb||"").match(/^\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*$/);
  if(!m) return null;
  const r = clamp(parseInt(m[1],10),0,255);
  const g = clamp(parseInt(m[2],10),0,255);
  const b = clamp(parseInt(m[3],10),0,255);
  return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
}
function hexToRgb(hex){
  const h = String(hex||"").replace("#","").trim();
  if(!/^[0-9a-fA-F]{6}$/.test(h)) return "";
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `${r},${g},${b}`;
}
function cleanLine(s){
  return String(s??"").replace(/\r/g,"").trimEnd();
}

/* -----------------------------
  Combo color UI
------------------------------*/
let comboColors = []; // array of {hex:"#...", name:"Combo1"}

function renderComboList(){
  const wrap = $("comboList");
  wrap.innerHTML = "";

  comboColors.forEach((c, idx)=>{
    const row = document.createElement("div");
    row.className = "colorRow";

    const label = document.createElement("div");
    label.className = "mini";
    label.textContent = `Combo${idx+1}`;

    const pick = document.createElement("input");
    pick.type = "color";
    pick.value = c.hex || "#ffffff";
    pick.addEventListener("input", ()=>{
      comboColors[idx].hex = pick.value;
      scheduleUpdate();
    });

    const remove = document.createElement("button");
    remove.className = "btn danger";
    remove.type = "button";
    remove.textContent = "Remove";
    remove.addEventListener("click", ()=>{
      comboColors.splice(idx,1);
      renderComboList();
      scheduleUpdate();
    });

    row.appendChild(label);
    row.appendChild(pick);
    row.appendChild(remove);
    wrap.appendChild(row);
  });

  if(comboColors.length === 0){
    const empty = document.createElement("div");
    empty.className = "mini";
    empty.textContent = "No combo colors yet. Add one or use the preset.";
    wrap.appendChild(empty);
  }
}

function ensureDefaultCombos(){
  if(comboColors.length === 0){
    comboColors = [{hex:"#ffc000"},{hex:"#00ca00"},{hex:"#00aaff"},{hex:"#ff5aa5"}];
    renderComboList();
  }
}

/* -----------------------------
  Ini generation
------------------------------*/
function genIni(){
  const lines = [];

  // [General]
  const gName = cleanLine($("gName").value);
  const gAuthor = cleanLine($("gAuthor").value);
  const gVersion = cleanLine($("gVersion").value);

  const general = [];
  if(gName) general.push(`Name: ${gName}`);
  if(gAuthor) general.push(`Author: ${gAuthor}`);
  if(gVersion) general.push(`Version: ${gVersion}`);

  // toggles
  general.push(`CursorCentre: ${bool01($("gCursorCentre").checked)}`);
  general.push(`CursorExpand: ${bool01($("gCursorExpand").checked)}`);
  general.push(`CursorRotate: ${bool01($("gCursorRotate").checked)}`);
  general.push(`CursorTrailRotate: ${bool01($("gCursorTrailRotate").checked)}`);

  if(general.length){
    lines.push("[General]");
    lines.push(...general);
    lines.push("");
  }

  // [Colours]
  const colours = [];
  comboColors.forEach((c, i)=>{
    const rgb = hexToRgb(c.hex);
    colours.push(`Combo${i+1}: ${rgb}`);
  });

  const sb = cleanLine($("cSliderBorder").value);
  const st = cleanLine($("cSliderTrack").value);
  if(sb) colours.push(`SliderBorder: ${sb}`);
  if(st) colours.push(`SliderTrackOverride: ${st}`);

  if(colours.length){
    lines.push("[Colours]");
    lines.push(...colours);
    lines.push("");
  }

  // [Fonts]
  const fonts = [];
  const fHitPrefix = cleanLine($("fHitPrefix").value);
  const fHitOverlap = $("fHitOverlap").value;
  const fScorePrefix = cleanLine($("fScorePrefix").value);
  const fScoreOverlap = $("fScoreOverlap").value;
  const fComboPrefix = cleanLine($("fComboPrefix").value);
  const fComboOverlap = $("fComboOverlap").value;

  const fScoreNumbers = $("fScoreNumbers").value;
  const fComboNumbers = $("fComboNumbers").value;

  if(fHitPrefix) fonts.push(`HitCirclePrefix: ${fHitPrefix}`);
  if(String(fHitOverlap).length) fonts.push(`HitCircleOverlap: ${fHitOverlap}`);

  if(fScorePrefix) fonts.push(`ScorePrefix: ${fScorePrefix}`);
  if(String(fScoreOverlap).length) fonts.push(`ScoreOverlap: ${fScoreOverlap}`);

  if(fComboPrefix) fonts.push(`ComboPrefix: ${fComboPrefix}`);
  if(String(fComboOverlap).length) fonts.push(`ComboOverlap: ${fComboOverlap}`);

  if(fScoreNumbers !== "") fonts.push(`ScoreNumbers: ${fScoreNumbers}`);
  if(fComboNumbers !== "") fonts.push(`ComboNumbers: ${fComboNumbers}`);

  if(fonts.length){
    lines.push("[Fonts]");
    lines.push(...fonts);
    lines.push("");
  }

  // [Mania] (simple)
  const keys = parseInt($("mKeys").value, 10);
  const mw = $("mColWidth").value;
  const ms = $("mColSpacing").value;
  const mlw = $("mLineWidth").value;
  const hitPos = $("mHitPos").value;
  const scorePos = $("mScorePos").value;
  const flip = $("mFlip").checked;

  const centerDifferent = $("mCenterDifferent").checked;
  const centerWidth = $("mCenterWidth").value;

  // We only include mania if user touched it OR if they keep defaults? We'll include if keys exists (always) but can gate:
  const mania = [];
  mania.push(`Keys: ${keys}`);
  mania.push(`ColumnWidth: ${buildColumnWidth(keys, mw, centerDifferent, centerWidth)}`);
  mania.push(`ColumnSpacing: ${csvBetween(ms, keys)}`);
  mania.push(`ColumnLineWidth: ${csvRepeat(mlw, keys)}`);
  mania.push(`HitPosition: ${hitPos}`);
  mania.push(`ScorePosition: ${scorePos}`);
  mania.push(`KeyFlipWhenUpsideDown: ${bool01(flip)}`);

  if(mania.length){
    lines.push("[Mania]");
    lines.push(...mania);
    lines.push("");
  }

  // Advanced extra
  const extra = $("aExtra").value.replace(/\r/g,"").trim();
  if(extra){
    lines.push("; ---- extra (user) ----");
    lines.push(extra);
    lines.push("");
  }

  // Cleanup: remove trailing empty lines
  while(lines.length && lines[lines.length-1] === "") lines.pop();
  return lines.join("\n");
}

/* -----------------------------
  Autosave state
------------------------------*/
let saveTimer = null;
function saveState(){
  const state = {
    gName: $("gName").value, gAuthor: $("gAuthor").value, gVersion: $("gVersion").value,
    gCursorCentre: $("gCursorCentre").checked, gCursorExpand: $("gCursorExpand").checked,
    gCursorRotate: $("gCursorRotate").checked, gCursorTrailRotate: $("gCursorTrailRotate").checked,

    comboColors,

    cSliderBorder: $("cSliderBorder").value,
    cSliderTrack: $("cSliderTrack").value,

    fHitPrefix: $("fHitPrefix").value,
    fHitOverlap: $("fHitOverlap").value,
    fScorePrefix: $("fScorePrefix").value,
    fScoreOverlap: $("fScoreOverlap").value,
    fComboPrefix: $("fComboPrefix").value,
    fComboOverlap: $("fComboOverlap").value,
    fScoreNumbers: $("fScoreNumbers").value,
    fComboNumbers: $("fComboNumbers").value,

    mKeys: $("mKeys").value,
    mColWidth: $("mColWidth").value,
    mColSpacing: $("mColSpacing").value,
    mLineWidth: $("mLineWidth").value,
    mHitPos: $("mHitPos").value,
    mScorePos: $("mScorePos").value,
    mFlip: $("mFlip").checked,
    mCenterDifferent: $("mCenterDifferent").checked,
    mCenterWidth: $("mCenterWidth").value,

    aExtra: $("aExtra").value
  };
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    $("autosaveState").textContent = "Saved";
    setTimeout(()=>{ $("autosaveState").textContent = ""; }, 700);
  }catch(e){}
}

function loadState(){
  let raw = null;
  try{ raw = localStorage.getItem(STORAGE_KEY); }catch(e){}
  if(!raw) return;

  try{
    const s = JSON.parse(raw);
    if(!s) return;

    $("gName").value = s.gName ?? "";
    $("gAuthor").value = s.gAuthor ?? "";
    $("gVersion").value = s.gVersion ?? "";

    $("gCursorCentre").checked = !!s.gCursorCentre;
    $("gCursorExpand").checked = !!s.gCursorExpand;
    $("gCursorRotate").checked = !!s.gCursorRotate;
    $("gCursorTrailRotate").checked = !!s.gCursorTrailRotate;

    comboColors = Array.isArray(s.comboColors) ? s.comboColors : [];
    renderComboList();

    $("cSliderBorder").value = s.cSliderBorder ?? "";
    $("cSliderTrack").value = s.cSliderTrack ?? "";

    $("fHitPrefix").value = s.fHitPrefix ?? "";
    $("fHitOverlap").value = s.fHitOverlap ?? "-2";
    $("fScorePrefix").value = s.fScorePrefix ?? "";
    $("fScoreOverlap").value = s.fScoreOverlap ?? "0";
    $("fComboPrefix").value = s.fComboPrefix ?? "";
    $("fComboOverlap").value = s.fComboOverlap ?? "0";
    $("fScoreNumbers").value = s.fScoreNumbers ?? "";
    $("fComboNumbers").value = s.fComboNumbers ?? "";

    $("mKeys").value = s.mKeys ?? "7";
    $("mColWidth").value = s.mColWidth ?? "70";
    $("mColSpacing").value = s.mColSpacing ?? "0";
    $("mLineWidth").value = s.mLineWidth ?? "0";
    $("mHitPos").value = s.mHitPos ?? "402";
    $("mScorePos").value = s.mScorePos ?? "260";
    $("mFlip").checked = !!s.mFlip;

    $("mCenterDifferent").checked = !!s.mCenterDifferent;
    $("mCenterWidth").value = s.mCenterWidth ?? "80";

    $("aExtra").value = s.aExtra ?? "";
  }catch(e){}
}

/* -----------------------------
  Live update
------------------------------*/
function updatePreview(){
  const ini = genIni();
  $("preview").value = ini;

  $("statChars").textContent = `Chars: ${ini.length}`;
  $("statLines").textContent = `Lines: ${ini ? ini.split("\n").length : 0}`;
}

function scheduleUpdate(){
  updatePreview();
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveState, 250);
}

/* -----------------------------
  Tabs
------------------------------*/
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  ["general","colours","fonts","mania","advanced"].forEach(k=>{
    $("tab-"+k).style.display = (k===name) ? "block" : "none";
  });
}

/* -----------------------------
  Colour pick sync (slider fields)
------------------------------*/
function bindColourSync(pickId, textId){
  const pick = $(pickId);
  const txt = $(textId);

  // init pick if rgb present
  const hx = rgbToHex(txt.value);
  if(hx) pick.value = hx;

  pick.addEventListener("input", ()=>{
    txt.value = hexToRgb(pick.value);
    scheduleUpdate();
  });
  txt.addEventListener("input", ()=>{
    const hx2 = rgbToHex(txt.value);
    if(hx2) pick.value = hx2;
    scheduleUpdate();
  });
}

/* -----------------------------
  Import (basic)
------------------------------*/
function parseIni(text){
  const out = {};
  let section = "";
  const lines = String(text||"").replace(/\r/g,"").split("\n");
  for(const raw of lines){
    const line = raw.trim();
    if(!line || line.startsWith(";") || line.startsWith("//")) continue;
    const sec = line.match(/^\[(.+)\]$/);
    if(sec){ section = sec[1].trim(); continue; }
    const kv = line.split(":");
    if(kv.length < 2) continue;
    const key = kv.shift().trim();
    const value = kv.join(":").trim();
    if(!out[section]) out[section] = {};
    out[section][key] = value;
  }
  return out;
}

function importNow(){
  const text = $("aImport").value;
  if(!text.trim()) return;

  const ini = parseIni(text);

  // General
  const G = ini["General"] || {};
  if(G["Name"]!==undefined) $("gName").value = G["Name"];
  if(G["Author"]!==undefined) $("gAuthor").value = G["Author"];
  if(G["Version"]!==undefined) $("gVersion").value = G["Version"];

  const boolKeys = ["CursorCentre","CursorExpand","CursorRotate","CursorTrailRotate"];
  boolKeys.forEach(k=>{
    if(G[k]!==undefined) $( "g"+k ).checked = String(G[k]).trim() === "1";
  });

  // Colours
  const C = ini["Colours"] || {};
  // collect ComboN
  const combos = Object.keys(C)
    .filter(k=>/^Combo\d+$/.test(k))
    .sort((a,b)=>parseInt(a.replace("Combo",""),10)-parseInt(b.replace("Combo",""),10))
    .map(k=>rgbToHex(C[k]) || "#ffffff");
  comboColors = combos.map(h=>({hex:h}));
  renderComboList();

  if(C["SliderBorder"]!==undefined) $("cSliderBorder").value = C["SliderBorder"];
  if(C["SliderTrackOverride"]!==undefined) $("cSliderTrack").value = C["SliderTrackOverride"];
  // resync pickers
  bindColourSync("cSliderBorderPick","cSliderBorder");
  bindColourSync("cSliderTrackPick","cSliderTrack");

  // Fonts
  const F = ini["Fonts"] || {};
  const mapFonts = [
    ["HitCirclePrefix","fHitPrefix"],["HitCircleOverlap","fHitOverlap"],
    ["ScorePrefix","fScorePrefix"],["ScoreOverlap","fScoreOverlap"],
    ["ComboPrefix","fComboPrefix"],["ComboOverlap","fComboOverlap"],
    ["ScoreNumbers","fScoreNumbers"],["ComboNumbers","fComboNumbers"]
  ];
  mapFonts.forEach(([k,id])=>{
    if(F[k]!==undefined) $(id).value = F[k];
  });

  // Mania (first [Mania] block)
  const M = ini["Mania"] || {};
  if(M["Keys"]!==undefined) $("mKeys").value = String(M["Keys"]).trim();
  if(M["HitPosition"]!==undefined) $("mHitPos").value = M["HitPosition"];
  if(M["ScorePosition"]!==undefined) $("mScorePos").value = M["ScorePosition"];
  if(M["KeyFlipWhenUpsideDown"]!==undefined) $("mFlip").checked = String(M["KeyFlipWhenUpsideDown"]).trim()==="1";

  // For lists we simplify by taking the first number
  if(M["ColumnWidth"]!==undefined){
    const first = String(M["ColumnWidth"]).split(",")[0].trim();
    if(first) $("mColWidth").value = first;
  }
  if(M["ColumnSpacing"]!==undefined){
    const first = String(M["ColumnSpacing"]).split(",")[0].trim();
    if(first) $("mColSpacing").value = first;
  }
  if(M["ColumnLineWidth"]!==undefined){
    const first = String(M["ColumnLineWidth"]).split(",")[0].trim();
    if(first) $("mLineWidth").value = first;
  }

  scheduleUpdate();
}

/* -----------------------------
  Download / Copy / Reset
------------------------------*/
function downloadIni(){
  const text = $("preview").value;
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "skin.ini";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function copyIni(){
  const text = $("preview").value;
  try{
    await navigator.clipboard.writeText(text);
    $("autosaveState").textContent = "Copied";
    setTimeout(()=>{ $("autosaveState").textContent = ""; }, 700);
  }catch(e){
    // fallback
    $("preview").focus();
    $("preview").select();
    document.execCommand("copy");
  }
}

function resetAll(){
  if(!confirm("Reset everything? This will clear autosaved state too.")) return;
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  location.reload();
}

/* -----------------------------
  Wiring
------------------------------*/
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});

// Inputs update
[
  "gName","gAuthor","gVersion",
  "gCursorCentre","gCursorExpand","gCursorRotate","gCursorTrailRotate",
  "cSliderBorder","cSliderTrack",
  "fHitPrefix","fHitOverlap","fScorePrefix","fScoreOverlap","fComboPrefix","fComboOverlap","fScoreNumbers","fComboNumbers",
  "mKeys","mColWidth","mColSpacing","mLineWidth","mHitPos","mScorePos","mFlip","mCenterDifferent","mCenterWidth",
  "aExtra"
].forEach(id=>{
  $(id).addEventListener("input", scheduleUpdate);
  $(id).addEventListener("change", scheduleUpdate);
});

// Buttons
$("downloadIni").addEventListener("click", downloadIni);
$("copyIni").addEventListener("click", copyIni);
$("resetAll").addEventListener("click", resetAll);

$("addCombo").addEventListener("click", ()=>{
  comboColors.push({hex:"#ffffff"});
  renderComboList();
  scheduleUpdate();
});
$("presetCombos").addEventListener("click", ()=>{
  comboColors = [
    {hex:"#ffc000"},
    {hex:"#00ca00"},
    {hex:"#00aaff"},
    {hex:"#ff5aa5"}
  ];
  renderComboList();
  scheduleUpdate();
});

$("doImport").addEventListener("click", importNow);

// colour sync pickers
bindColourSync("cSliderBorderPick","cSliderBorder");
bindColourSync("cSliderTrackPick","cSliderTrack");

// Load state + init
loadState();
ensureDefaultCombos();
renderComboList();
updatePreview();
</script>
</body>
</html>
